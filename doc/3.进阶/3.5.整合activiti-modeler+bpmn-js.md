# 整合 activiti-modeler + bpmn-js

## 一、Vue3 整合 Activiti Modeler

官网：https://www.activiti.org/get-started

--- 

1. 下载5.x Download包，解压 activiti-5.22.0.zip，找到 wars/activiti-explorer.war
   解压，把 diagram-viewer 文件夹、editor-app 文件夹和 modeler.html
   页面文件拷贝到前端模块 `spring-boot-activiti/web/public/activiti-explorer` 目录下；

- 下载的设计界面是英文，对应的语言包文件在这个路径：

  `activiti-5.22.0/wars/activiti-explorer/WEB-INF/classes/stencilset.json`

- 把它复制到 `spring-boot-activiti/src/main/resourcesresources/static/stencilset.json`，可以自己翻译，修改每个节点
  properties 里面的 title 字段，或者使用项目中已经翻译好的文件。

2. 添加接口来返回 stencilset.json 文件：

   `io.github.cmmplb.activiti.controller.ModelController`

    ````java
    package io.github.cmmplb.activiti.controller;
    
    import com.github.xiaoymin.knife4j.annotations.ApiOperationSupport;
    import com.github.xiaoymin.knife4j.annotations.ApiSupport;
    import io.github.cmmplb.activiti.handler.exection.BusinessException;
    import io.swagger.annotations.Api;
    import io.swagger.annotations.ApiOperation;
    import lombok.extern.slf4j.Slf4j;
    import org.apache.commons.io.IOUtils;
    import org.springframework.web.bind.annotation.GetMapping;
    import org.springframework.web.bind.annotation.RequestMapping;
    import org.springframework.web.bind.annotation.RestController;
    
    import java.io.IOException;
    import java.nio.charset.StandardCharsets;
    import java.util.Objects;
    
    /**
     * @author penglibo
     * @date 2024-10-28 17:22:18
     * @since jdk 1.8
     */
    
    @Api(tags = "activiti-modeler 流程设计管理")
    @Slf4j
    @RestController
    @ApiSupport(order = 2)
    @RequestMapping("/modeler")
    public class ModelerController {
    
        @ApiOperation("获取 stencilset 配置")
        @GetMapping(value = "/stencilset")
        @ApiOperationSupport(order = 1)
        public String getStencilSet() {
            // 这里的接口路径对应 /web/public/editor-app/configuration/url-config.js 这个配置文件
            // 后面时间戳我感觉是为了防止前端 get 请求缓存的问题, 加上时间戳取最新的
            // return ACTIVITI.CONFIG.contextRoot + '/modeler/stencilset?version=' + Date.now();
            ClassLoader classLoader = this.getClass().getClassLoader();
            try {
                return IOUtils.toString(Objects.requireNonNull(classLoader.getResourceAsStream("static/stencilset-zh.json")), StandardCharsets.UTF_8);
            } catch (IOException e) {
                throw new BusinessException("获取 stencilset 配置文件失败");
            }
        }
    }
    
    ````

3. 添加 activiti-modeler.vue 文件用于显示设计界面，使用 iframe 嵌入 activiti 的 model.html

   `spring-boot-activiti/web/src/views/process/model/activiti-modeler.vue`

- 这里的 modelId 先从数据库模写死一个 id，后面再做修改，同时挂载一下项目路径前缀，因为使用了代理，这里的 $contextRoot
  为环境变量中配置的 VITE_APP_BASE_API。

    ````vue
    
    <template>
      <div class='activiti-modeler-container'>
        <iframe width="100%" height="100%"
                src="/activiti-explorer/modeler.html?modelId=a97af726-942a-11ef-b870-3ed4e00e59f8"></iframe>
      </div>
    </template>
    
    <script setup lang="ts">
      import {onMounted} from 'vue';
    
      onMounted(() => {
        // 通过 window 对象全局挂载全局对象或者属性, 存放在内存刷新会清空, 这并不是推荐的做法, 因为直接修改全局对象可能会导致命名冲突, 难以进行模块化管理以及不利于应用的封装与维护
        window.$contextRoot = import.meta.env.VITE_APP_BASE_API;
      });
    
    </script>
    
    <style scoped lang='scss'>
      .activiti-modeler-container {
        width: 100vw;
        // 设置成 100 右侧会有一个滚动条
        height: 99vh;
      }
    </style>
    ````

- 添加 window$contextRoot 的 ts 类型声明：

  `spring-boot-activiti/web/src/types/global.d.ts`

    ````typescript
    // 声明全局变量
    interface Window {
      $contextRoot: string
    }
    ````

4. 配置路由

   `spring-boot-activiti/web/src/router/index.ts`

   添加 path: '/process/activiti-modeler',

    ````typescript
    // 公共静态路由
    const constantRoutes = [
      // ...
      {
        path: '/activiti-modeler',
        component: () => import ('@/views/process/model/activiti-modeler.vue'),
        name: 'activiti-modeler 模型设计'
      }
    ];
    ````

5. 修改 editor-app/app-cfg.js，从刚刚挂载的全局属性中获取请求路径

    ````javascript
    ACTIVITI.CONFIG = {
      // 'contextRoot' : '/activiti-explorer/service',
      'contextRoot': (function () {
        // 获取父页面 window 挂载的全局属性
        return window.parent.$contextRoot;
      })()
    };
    ````

---

### 整合注意点

1. 获取模型流程设计：

   在 ModelController.getEditorJson 获取模型流程设计的接口中，返回的结果是 Result<ModelVO>，包装了一层，而在
   activiti-modeler 页面里面获取的数据解析不到最里面的 model json对象，这里可以改成直接返回 ModelVO 类中的 JSONObject
   model，或者修改activiti-modeler 页面源码，让其能解析到最里面的 model 对象。

- 我这里是修改源码来解析，位置在：

  `spring-boot-activiti/web/public/activiti-explorer/editor-app/app.js`

   ````javascript
   function fetchModel(modelId) {
   
      var modelUrl = KISBPM.URL.getModel(modelId);
   
      $http({method: 'GET', url: modelUrl}).success(function (data, status, headers, config) {
         // 这里把 data 解构一层
         data = data.data;
   
         $rootScope.editor = new ORYX.Editor(data);
         $rootScope.modelData = angular.fromJson(data);
         $rootScope.editorFactory.resolve();
      }).error(function (data, status, headers, config) {
         console.log('Error loading model with id ' + modelId + ' ' + data);
      });
   }
   ````

2. 流程设计接口迁移：

    - 考虑到后面整合 bpmn-js，把 modeler 的单独存放，以后项目整合要是来找示例也方便，把之前写在 ModelController
      的保存流程设计和获取模型流程设计挪到 ModelerController 中：

   `io.github.cmmplb.activiti.controller.ModelerController`

    ````java
    package io.github.cmmplb.activiti.controller;
    
    import com.github.xiaoymin.knife4j.annotations.ApiOperationSupport;
    import com.github.xiaoymin.knife4j.annotations.ApiSupport;
    import io.github.cmmplb.activiti.domain.dto.ModelerDTO;
    import io.github.cmmplb.activiti.domain.vo.ModelerVO;
    import io.github.cmmplb.activiti.handler.exection.BusinessException;
    import io.github.cmmplb.activiti.result.Result;
    import io.github.cmmplb.activiti.result.ResultUtil;
    import io.github.cmmplb.activiti.service.ModelerService;
    import io.swagger.annotations.Api;
    import io.swagger.annotations.ApiOperation;
    import lombok.extern.slf4j.Slf4j;
    import org.apache.commons.io.IOUtils;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.web.bind.annotation.*;
    
    import java.io.IOException;
    import java.nio.charset.StandardCharsets;
    import java.util.Objects;
    
    /**
     * @author penglibo
     * @date 2024-10-28 17:22:18
     * @since jdk 1.8
     */
    
    @Api(tags = "流程设计管理")
    @Slf4j
    @RestController
    @ApiSupport(order = 2)
    @RequestMapping("/modeler")
    public class ModelerController {
    
        @Autowired
        private ModelerService modelService;
    
        @ApiOperation("获取 stencilset 配置")
        @GetMapping(value = "/stencilset")
        @ApiOperationSupport(order = 1)
        public String getStencilSet() {
            // 这里的接口路径对应 /web/public/activiti-explorer/editor-app/configuration/url-config.js 这个配置文件
            // 后面时间戳我感觉是为了防止前端 get 请求缓存的问题, 加上时间戳取最新的
            // return ACTIVITI.CONFIG.contextRoot + '/editor/stencilset?version=' + Date.now();
            ClassLoader classLoader = this.getClass().getClassLoader();
            try {
                return IOUtils.toString(Objects.requireNonNull(classLoader.getResourceAsStream("static/stencilset-zh.json")), StandardCharsets.UTF_8);
            } catch (IOException e) {
                throw new BusinessException("获取 stencilset 配置文件失败");
            }
        }
    
        // 这里的接口路径对应 /web/public/activiti-explorer/editor-app/configuration/url-config.js -> putModel 这个配置文件接口
        @ApiOperation("保存流程设计")
        @PutMapping(value = "/save/{id}")
        @ApiOperationSupport(order = 2, ignoreParameters = {"id"})
        public Result<Boolean> saveDesign(@PathVariable(value = "id") String id, ModelerDTO dto) {
            dto.setId(id);
            return ResultUtil.success(modelService.saveDesign(dto));
        }
    
        // 这里的接口路径对应 /web/public/activiti-explorer/editor-app/configuration/url-config.js -> getModel 这个配置文件接口
        @ApiOperation("根据流程 id 获取模型流程设计 json 信息")
        @GetMapping(value = "/json/{id}")
        @ApiOperationSupport(order = 3, ignoreParameters = {"id"})
        public Result<ModelerVO> getModelerJsonById(@PathVariable(value = "id") String id) {
            return ResultUtil.success(modelService.getModelerJsonById(id));
        }
    }
    ````

    - ModelerDTO：

   `io.github.cmmplb.activiti.domain.dto.ModelerDTO`

    ````java
    package io.github.cmmplb.activiti.domain.dto;
    
    import io.swagger.annotations.ApiModel;
    import io.swagger.annotations.ApiModelProperty;
    import lombok.Data;
    
    /**
     * @author penglibo
     * @date 2023-10-17 11:13:43
     * @since jdk 1.8
     * 模型参数
     */
    
    @Data
    @ApiModel(value = "ModelerDTO", description = "流程设计请求参数")
    public class ModelerDTO {
    
        @ApiModelProperty(value = "模型ID", hidden = true)
        private String id;
    
        @ApiModelProperty(value = "模型名称", example = "请假申请")
        private String name;
    
        @ApiModelProperty(value = "模型描述", example = "请假申请流程")
        private String description;
    
        @ApiModelProperty(value = "流程设计文件 xml")
        private String jsonXml;
    
        @ApiModelProperty(value = "流程设计图片 svg")
        private String svgXml;
    
    }
    ````

    - ModelDTO：

   `io.github.cmmplb.activiti.domain.dto.ModelDTO`

    ````java
    package io.github.cmmplb.activiti.domain.dto;
    
    import io.swagger.annotations.ApiModel;
    import io.swagger.annotations.ApiModelProperty;
    import lombok.Data;
    
    /**
     * @author penglibo
     * @date 2023-10-17 11:13:43
     * @since jdk 1.8
     * 模型参数
     */
    
    @Data
    @ApiModel(value = "ModelDTO", description = "模型请求参数")
    public class ModelDTO {
    
        @ApiModelProperty(value = "模型ID", hidden = true)
        private String id;
    
        @ApiModelProperty(value = "模型关键字", example = "LEAVE_APPLY")
        private String key;
    
        @ApiModelProperty(value = "模型名称", example = "请假申请")
        private String name;
    
        @ApiModelProperty(value = "模型作者", example = "cmmplb")
        private String author;
    
        @ApiModelProperty(value = "模型类型", example = "leave")
        private String category;
    
        @ApiModelProperty(value = "模型描述", example = "请假申请流程")
        private String description;
    
        @ApiModelProperty(value = "设计类型:1-activiti modeler;2-bpmn-js;")
        private Integer designType;
    
        public static final String DESIGN_TYPE = "designType";
    }
    ````

    - ModelerVO：

   `io.github.cmmplb.activiti.domain.vo.ModelerVO`

    ````java
    package io.github.cmmplb.activiti.domain.vo;
    
    import com.alibaba.fastjson.JSONObject;
    import com.fasterxml.jackson.annotation.JsonFormat;
    import io.swagger.annotations.ApiModel;
    import io.swagger.annotations.ApiModelProperty;
    import lombok.Data;
    import org.apache.commons.lang3.StringUtils;
    
    import java.util.Date;
    
    /**
     * @author penglibo
     * @date 2023-10-17 11:13:43
     * @since jdk 1.8
     */
    
    @Data
    @ApiModel(value = "ModelerVO", description = "流程设计返回参数")
    public class ModelerVO {
    
        @ApiModelProperty(value = "设计页面中使用的字段为 modelId", example = "1")
        private String modelId;
    
        @ApiModelProperty(value = "名称", example = "请假模型")
        private String name;
    
        @ApiModelProperty(value = "创建时间", example = "2023-11-11 12:12:11")
        @JsonFormat(timezone = "GMT+8", pattern = "yyyy-MM-dd HH:mm:ss")
        private Date createTime;
    
        @ApiModelProperty(value = "模型描述", example = "请假申请流程")
        private String description;
    
        @ApiModelProperty(value = "以json格式保存流程定义的信息,数据源信息", example = "{\"name\":\"请假申请\",\"description\":\"请假申请流程\",\"revision\":1}")
        private String metaInfo;
    
        @ApiModelProperty(value = "流程设计 json 信息")
        private JSONObject model;
    
        // 以下两个字段对应 /editor-app/stencil-controller.js
        // if (canvasSelected) {
        //     selectedItem.auditData = {
        //         'author': $scope.modelData.createdByUser,
        //         'createDate': $scope.modelData.createDate
        //     };
        // }
        @ApiModelProperty(value = "流程设计页面创建人字段")
        private String createdByUser;
    
        @ApiModelProperty(value = "流程设计页面创建时间字段")
        @JsonFormat(timezone = "GMT+8", pattern = "yyyy-MM-dd HH:mm:ss")
        private Date createDate;
    
        // 重写方法
        public String getDescription() {
            if (StringUtils.isNotEmpty(metaInfo)) {
                // 获取 metaInfo 中的 description 信息
                return JSONObject.parseObject(metaInfo).getString("description");
            }
            return description;
        }
    
        public Date getCreateDate() {
            return createTime;
        }
    
        public String getCreatedByUser() {
            // 后续整合 SpringSecurity
            return "管理员";
        }
    }
    ````

    - ModelVO

   `io.github.cmmplb.activiti.domain.vo.ModelVO`

    ````java
    package io.github.cmmplb.activiti.domain.vo;
    
    import com.alibaba.fastjson.JSONObject;
    import com.fasterxml.jackson.annotation.JsonFormat;
    import io.github.cmmplb.activiti.domain.dto.ModelDTO;
    import io.swagger.annotations.ApiModel;
    import io.swagger.annotations.ApiModelProperty;
    import lombok.Data;
    import org.apache.commons.lang3.StringUtils;
    
    import java.util.Date;
    
    /**
     * @author penglibo
     * @date 2023-10-17 11:13:43
     * @since jdk 1.8
     */
    
    @Data
    @ApiModel(value = "ModelVO", description = "流程模型返回参数")
    public class ModelVO {
    
        @ApiModelProperty(value = "主键", example = "1")
        private String id;
    
        @ApiModelProperty(value = "名称", example = "请假模型")
        private String name;
    
        @ApiModelProperty(value = "模型作者", example = "cmmplb")
        private String author;
    
        @ApiModelProperty(value = "模型关键字", example = "leave")
        private String key;
    
        @ApiModelProperty(value = "模型类型", example = "home")
        private String category;
    
        @ApiModelProperty(value = "创建时间", example = "2023-11-11 12:12:11")
        @JsonFormat(timezone = "GMT+8", pattern = "yyyy-MM-dd HH:mm:ss")
        private Date createTime;
    
        @ApiModelProperty(value = "最后更新时间", example = "2023-11-11 12:12:11")
        @JsonFormat(timezone = "GMT+8", pattern = "yyyy-MM-dd HH:mm:ss")
        private Date lastUpdateTime;
    
        @ApiModelProperty(value = "版本，从1开始", example = "1")
        private Integer version;
    
        @ApiModelProperty(value = "模型描述", example = "请假申请流程")
        private String description;
    
        @ApiModelProperty(value = "以json格式保存流程定义的信息,数据源信息", example = "{\"name\":\"请假申请\",\"description\":\"请假申请流程\",\"revision\":1,\"designType\":1}")
        private String metaInfo;
    
        @ApiModelProperty(value = "部署ID", example = "1")
        private String deploymentId;
    
        @ApiModelProperty(value = "设计类型:1-activiti modeler;2-bpmn-js;")
        private Integer designType;
    
        // 重写方法
        public String getDescription() {
            if (StringUtils.isNotEmpty(metaInfo)) {
                // 获取 metaInfo 中的 description 信息
                return JSONObject.parseObject(metaInfo).getString("description");
            }
            return description;
        }
    
        // 重写方法
        public Integer getDesignType() {
            if (StringUtils.isNotEmpty(metaInfo)) {
                // 获取 metaInfo 中的 description 信息
                return JSONObject.parseObject(metaInfo).getInteger(ModelDTO.DESIGN_TYPE);
            }
            return designType;
        }
    }
    ````

    - Convert，注意使用 convert 的时候，需要编译一下，不然实体类 set 会找不到方法

   `io.github.cmmplb.activiti.convert.ModelerConvert`

    ````java
    package io.github.cmmplb.activiti.convert;
    
    import io.github.cmmplb.activiti.domain.vo.ModelerVO;
    import org.activiti.engine.repository.Model;
    import org.mapstruct.Mapper;
    
    /**
     * @author penglibo
     * @date 2022-08-03 16:56:25
     * @since jdk 1.8
     */
    
    @Mapper
    public interface ModelerConvert extends Converter<Model, ModelerVO> {
    
    }
    ````

    - ModelerService：

   `io.github.cmmplb.activiti.service.ModelerService`

    ````java
    package io.github.cmmplb.activiti.service;
    
    import io.github.cmmplb.activiti.domain.dto.ModelerDTO;
    import io.github.cmmplb.activiti.domain.vo.ModelerVO;
    
    /**
     * @author penglibo
     * @date 2024-10-28 17:29:11
     * @since jdk 1.8
     */
    public interface ModelerService {
    
        boolean saveDesign(ModelerDTO dto);
    
        ModelerVO getModelerJsonById(String id);
    }
    ````

    - ModelService

   `io.github.cmmplb.activiti.service.ModelService`
    ````java
    package io.github.cmmplb.activiti.service;
    
    import com.alibaba.fastjson.JSONObject;
    import io.github.cmmplb.activiti.beans.PageResult;
    import io.github.cmmplb.activiti.beans.QueryPageBean;
    import io.github.cmmplb.activiti.domain.dto.ModelDTO;
    import io.github.cmmplb.activiti.domain.vo.ModelVO;
    
    /**
     * @author penglibo
     * @date 2024-10-22 14:36:22
     * @since jdk 1.8
     */
    public interface ModelService {
    
        boolean save(ModelDTO dto);
    
        boolean update(ModelDTO dto);
    
        boolean removeById(String id);
    
        PageResult<ModelVO> getByPaged(QueryPageBean dto);
    
        ModelVO getInfoById(String id);
    
        void export(String id);
    
        boolean deployment(String id);
    
        void saveJsonXml(JSONObject bpmnXml, String id, String name, String description, String author, int revision);
    
        void saveSvg(String id, String svgXml);
    }
    ````

    - ModelerServiceImpl：

   `io.github.cmmplb.activiti.service.impl.ModelerServiceImpl`

    ````java
    package io.github.cmmplb.activiti.service.impl;
    
    import com.alibaba.fastjson.JSON;
    import com.alibaba.fastjson.JSONObject;
    import io.github.cmmplb.activiti.convert.ModelerConvert;
    import io.github.cmmplb.activiti.domain.dto.ModelerDTO;
    import io.github.cmmplb.activiti.domain.vo.ModelerVO;
    import io.github.cmmplb.activiti.handler.exection.BusinessException;
    import io.github.cmmplb.activiti.service.ModelService;
    import io.github.cmmplb.activiti.service.ModelerService;
    import io.github.cmmplb.activiti.utils.ConverterUtil;
    import org.activiti.editor.constants.ModelDataJsonConstants;
    import org.activiti.engine.RepositoryService;
    import org.activiti.engine.repository.Model;
    import org.bouncycastle.util.Arrays;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.stereotype.Service;
    
    import java.nio.charset.StandardCharsets;
    
    /**
     * @author penglibo
     * @date 2024-10-28 17:29:29
     * @since jdk 1.8
     */
    
    @Service
    public class ModelerServiceImpl implements ModelerService {
    
        @Autowired
        private ModelService modelService;
    
        @Autowired
        private RepositoryService repositoryService;
    
        @Override
        public boolean saveDesign(ModelerDTO dto) {
            Model model = repositoryService.getModel(dto.getId());
            if (null == model) {
                throw new RuntimeException("模型信息不存在");
            }
            // 前端调用的参数：toolbar-default-actions.js：
            // var params = {
            //  jsonXml: json,
            //  svgXml: svgDOM,
            //  name: $scope.saveDialog.name,
            //  description: $scope.saveDialog.description
            // };
            JSONObject metaInfo = JSON.parseObject(model.getMetaInfo());
    
            // 版本号, 这里直接在代码里加 1 了, 应该在数据库利用行锁 version = version + 1 的方式来修改, 或者加锁, 防止数据重复更新
            int revision = model.getVersion() + 1;
            // 设计界面也可以修改相关模型信息
            metaInfo.put(ModelDataJsonConstants.MODEL_NAME, dto.getName());
            // 版本号从模型信息中获取, 因为设计页面上的版本号是字符串, 而模型信息的版本号是 int, 防止转换异常
            metaInfo.put(ModelDataJsonConstants.MODEL_REVISION, revision);
            metaInfo.put(ModelDataJsonConstants.MODEL_DESCRIPTION, dto.getDescription());
    
            model.setMetaInfo(metaInfo.toString());
            model.setName(dto.getName());
            model.setVersion(revision);
            // 更新模型信息
            repositoryService.saveModel(model);
    
            // 更新流程设计文件
            modelService.saveJsonXml(JSON.parseObject(dto.getJsonXml()), dto.getId(), dto.getName(), dto.getDescription(), null, revision);
    
            // 更新流程图片信息
            modelService.saveSvg(dto.getId(), dto.getSvgXml());
            return true;
        }
    
        @Override
        public ModelerVO getModelerJsonById(String id) {
            Model model = repositoryService.getModel(id);
            if (null == model) {
                throw new BusinessException("模型信息不存在");
            }
            ModelerVO vo = ConverterUtil.convert(ModelerConvert.class, model);
            vo.setModelId(model.getId());
            // 获取流程定义文件
            byte[] modelData = repositoryService.getModelEditorSource(id);
            if (!Arrays.isNullOrEmpty(modelData)) {
                String modelInfo = new String(modelData, StandardCharsets.UTF_8);
                vo.setModel(JSON.parseObject(modelInfo));
            }
            return vo;
        }
    }
    ````

    - ModelServiceImpl：

   `io.github.cmmplb.activiti.service.impl.ModelServiceImpl`

    ````java
    package io.github.cmmplb.activiti.service.impl;
    
    import com.alibaba.fastjson.JSON;
    import com.alibaba.fastjson.JSONObject;
    import com.fasterxml.jackson.databind.JsonNode;
    import com.fasterxml.jackson.databind.ObjectMapper;
    import io.github.cmmplb.activiti.beans.PageResult;
    import io.github.cmmplb.activiti.beans.QueryPageBean;
    import io.github.cmmplb.activiti.convert.ModelConvert;
    import io.github.cmmplb.activiti.domain.dto.ModelDTO;
    import io.github.cmmplb.activiti.domain.vo.ModelVO;
    import io.github.cmmplb.activiti.handler.exection.BusinessException;
    import io.github.cmmplb.activiti.service.ModelService;
    import io.github.cmmplb.activiti.utils.ConverterUtil;
    import io.github.cmmplb.activiti.utils.ServletUtil;
    import org.activiti.bpmn.converter.BpmnXMLConverter;
    import org.activiti.bpmn.model.BpmnModel;
    import org.activiti.editor.constants.EditorJsonConstants;
    import org.activiti.editor.constants.ModelDataJsonConstants;
    import org.activiti.editor.constants.StencilConstants;
    import org.activiti.editor.language.json.converter.BpmnJsonConverter;
    import org.activiti.engine.RepositoryService;
    import org.activiti.engine.repository.Deployment;
    import org.activiti.engine.repository.DeploymentBuilder;
    import org.activiti.engine.repository.Model;
    import org.activiti.engine.repository.ModelQuery;
    import org.apache.batik.transcoder.TranscoderException;
    import org.apache.batik.transcoder.TranscoderInput;
    import org.apache.batik.transcoder.TranscoderOutput;
    import org.apache.batik.transcoder.image.PNGTranscoder;
    import org.apache.commons.io.IOUtils;
    import org.apache.commons.lang3.StringUtils;
    import org.bouncycastle.util.Arrays;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.stereotype.Service;
    import org.springframework.util.CollectionUtils;
    
    import javax.servlet.http.HttpServletResponse;
    import java.io.ByteArrayInputStream;
    import java.io.ByteArrayOutputStream;
    import java.io.IOException;
    import java.io.InputStream;
    import java.nio.charset.StandardCharsets;
    import java.util.ArrayList;
    import java.util.HashMap;
    import java.util.List;
    import java.util.Map;
    import java.util.stream.Collectors;
    
    /**
     * @author penglibo
     * @date 2024-10-22 14:41:39
     * @since jdk 1.8
     */
    
    @Service
    public class ModelServiceImpl implements ModelService {
    
        @Autowired
        private ObjectMapper objectMapper;
    
        @Autowired
        private RepositoryService repositoryService;
    
        @Override
        public boolean save(ModelDTO dto) {
            // 校验模型关键字是否重复
            ModelQuery modelQuery = repositoryService.createModelQuery();
            List<Model> list = modelQuery.modelKey(dto.getKey()).list();
            if (!CollectionUtils.isEmpty(list)) {
                throw new BusinessException("模型标识不能重复");
            }
            // 初始化一个空模型, 这个 Model 实体对应 ACT_RE_MODEL 表
            Model model = repositoryService.newModel();
            // 模型名称
            model.setName(dto.getName());
            // 模型关键字
            model.setKey(dto.getKey());
            // 模型类型, 自定义
            model.setCategory(dto.getCategory());
            // 版本号, 默认为 1, 启动流程时如果是 startProcessInstanceByKey 启动的, 则会用最新版本的流程定义执行流程.
            int revision = 1;
            model.setVersion(revision);
            Map<String, Object> metaInfo = new HashMap<>();
            metaInfo.put(ModelDataJsonConstants.MODEL_NAME, dto.getName());
            metaInfo.put(ModelDataJsonConstants.MODEL_REVISION, revision);
            metaInfo.put(ModelDataJsonConstants.MODEL_DESCRIPTION, dto.getDescription());
            // 添加一个模型设计类型字段
            metaInfo.put(ModelDTO.DESIGN_TYPE, dto.getDesignType());
            // json 格式存储流程定义信息
            model.setMetaInfo(JSON.toJSONString(metaInfo));
            // 保存模型到 act_re_model 表
            repositoryService.saveModel(model);
    
            // 构建一个空模型文件 ModelEditorSource, 这个步骤是为了后续设计流程图时使用, 如果没有的话, activiti modeler 页面空白操作不了
            // 设计类型:1-activiti modeler;2-bpmn-js; bpmn-js 没有 properties 属性
            if (dto.getDesignType().equals(1)) {
                JSONObject bpmnXml = new JSONObject();
                // 为什么是 canvas 这个值? 可以去设计一个流程之后, 查看 getModelEditorSource 返回的 json 数据, 等后面写了流程设计之后查看
                bpmnXml.put(EditorJsonConstants.EDITOR_SHAPE_ID, "canvas");
    
                // 创建 activiti modeler 空节点
                HashMap<String, String> stencilset = new HashMap<>();
                stencilset.put("namespace", "http://b3mn.org/stencilset/bpmn2.0#");
                bpmnXml.put("stencilset", stencilset);
    
                // 更新流程设计文件
                saveJsonXml(bpmnXml, model.getId(), dto.getName(), dto.getDescription(), dto.getAuthor(), revision);
            } else {
                // 初始化一个开始节点的 bpmn-js 模型, 注意, 这里的 xml 我在设计界面中-> 常规-可执行文件勾选好了, 如果不勾选部署的时候会报错:
                // All process definition are set to be non-executable (property 'isExecutable' on process). This is not allowed. - [Extra info : ]
                String xml = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<bpmn:definitions xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:bpmn=\"http://www.omg.org/spec/BPMN/20100524/MODEL\" xmlns:bpmndi=\"http://www.omg.org/spec/BPMN/20100524/DI\" xmlns:dc=\"http://www.omg.org/spec/DD/20100524/DC\" id=\"Definitions_1\" targetNamespace=\"http://bpmn.io/schema/bpmn\"><bpmn:process id=\"Process_1\" isExecutable=\"true\"><bpmn:startEvent id=\"StartEvent_1\" /></bpmn:process><bpmndi:BPMNDiagram id=\"BPMNDiagram_1\"><bpmndi:BPMNPlane id=\"BPMNPlane_1\" bpmnElement=\"Process_1\"><bpmndi:BPMNShape id=\"_BPMNShape_StartEvent_2\" bpmnElement=\"StartEvent_1\"><dc:Bounds x=\"173\" y=\"102\" width=\"36\" height=\"36\" /></bpmndi:BPMNShape></bpmndi:BPMNPlane></bpmndi:BPMNDiagram></bpmn:definitions>";
                String svg = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<!-- created with bpmn-js / http://bpmn.io -->\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\" \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"46\" height=\"46\" viewBox=\"168 97 46 46\" version=\"1.1\"><g class=\"djs-group\"><g class=\"djs-element djs-shape\" data-element-id=\"StartEvent_1\" style=\"display: block;\" transform=\"matrix(1 0 0 1 173 102)\"><g class=\"djs-visual\"><circle cx=\"18\" cy=\"18\" r=\"18\" style=\"stroke-linecap: round; stroke-linejoin: round; stroke: rgb(34, 36, 42); stroke-width: 2px; fill: white; fill-opacity: 0.95;\"/></g><rect class=\"djs-hit djs-hit-all\" x=\"0\" y=\"0\" width=\"36\" height=\"36\" style=\"fill: none; stroke-opacity: 0; stroke: white; stroke-width: 15px;\"/><circle cx=\"18\" cy=\"18\" r=\"23\" class=\"djs-outline\" style=\"fill: none;\"/></g></g></svg>";
                // 添加流程设计文件, 注意, activiti-modeler 保存的是 json, bpmn-js 保存的是 xml
                repositoryService.addModelEditorSource(model.getId(), xml.getBytes(StandardCharsets.UTF_8));
    
                // 添加流程图片信息
                saveSvg(model.getId(), svg);
            }
            return true;
        }
    
        @Override
        public boolean update(ModelDTO dto) {
            Model model = repositoryService.getModel(dto.getId());
            if (null == model) {
                throw new RuntimeException("模型信息不存在");
            }
            // 校验模型关键字是否重复
            ModelQuery modelQuery = repositoryService.createModelQuery();
            List<Model> list = modelQuery.modelKey(dto.getKey()).list();
            if (!CollectionUtils.isEmpty(list) && !list.get(0).getId().equals(dto.getId())) {
                throw new RuntimeException("模型标识不能重复");
            }
            // 模型名称
            model.setName(dto.getName());
            // 模型关键字
            model.setKey(dto.getKey());
            // 模型类型
            model.setCategory(dto.getCategory());
            // 版本号, 这里直接在代码里加 1 了, 应该在数据库利用行锁 version = version + 1 的方式来修改, 或者加锁, 防止数据重复更新
            int revision = model.getVersion() + 1;
            model.setVersion(revision);
            JSONObject metaInfo = JSON.parseObject(model.getMetaInfo());
            metaInfo.put(ModelDataJsonConstants.MODEL_NAME, dto.getName());
            metaInfo.put(ModelDataJsonConstants.MODEL_REVISION, revision);
            metaInfo.put(ModelDataJsonConstants.MODEL_DESCRIPTION, dto.getDescription());
            // json 格式存储流程定义信息
            model.setMetaInfo(JSON.toJSONString(metaInfo));
            // 修改模型到 act_re_model 表（repositoryService 中修改和保存的方法是同一个）
            repositoryService.saveModel(model);
    
            byte[] modelData = repositoryService.getModelEditorSource(dto.getId());
            // 如果设计类型是 activiti modeler, 更新流程设计文件信息
            if (!Arrays.isNullOrEmpty(modelData) && dto.getDesignType().equals(1)) {
                saveJsonXml(JSON.parseObject(new String(modelData, StandardCharsets.UTF_8)),
                        dto.getId(), dto.getName(), dto.getDescription(), dto.getAuthor(), revision);
            }
            return true;
        }
    
        @Override
        public boolean removeById(String id) {
            Model model = repositoryService.getModel(id);
            if (null == model) {
                throw new RuntimeException("模型信息不存在");
            }
            // 删除模型会同时删除关联的流程定义文件, 也就是 act_ge_bytearray 表中一条关联的数据
            repositoryService.deleteModel(id);
            return true;
        }
    
        @Override
        public PageResult<ModelVO> getByPaged(QueryPageBean dto) {
            ModelQuery query = repositoryService.createModelQuery();
            if (StringUtils.isNotEmpty(dto.getKeywords())) {
                // 根据模型名称模糊查询
                query.modelNameLike(dto.getKeywords());
            }
            List<ModelVO> res = new ArrayList<>();
            // count 查询总数
            long total = query.count();
            if (total > 0) {
                // 分页查询
                List<Model> list = query.orderByCreateTime().desc().listPage(dto.getStart(), dto.getSize());
                // .stream().map() jdk 8 语法
                return new PageResult<>(total, list.stream().map(model -> ConverterUtil.convert(ModelConvert.class, model)
                ).collect(Collectors.toList()));
            }
            return new PageResult<>(total, res);
        }
    
        @Override
        public ModelVO getInfoById(String id) {
            Model model = repositoryService.getModel(id);
            if (null == model) {
                throw new RuntimeException("模型信息不存在");
            }
            ModelVO vo = ConverterUtil.convert(ModelConvert.class, model);
            // 获取流程定义文件
            byte[] modelData = repositoryService.getModelEditorSource(id);
            if (!Arrays.isNullOrEmpty(modelData)) {
                String metaInfo = model.getMetaInfo();
                JSONObject metaInfoJson = JSON.parseObject(metaInfo);
                if (metaInfoJson.getInteger(ModelDTO.DESIGN_TYPE).equals(1)) {
                    JSONObject bpmnXml = JSON.parseObject(new String(modelData, StandardCharsets.UTF_8));
                    JSONObject properties = bpmnXml.getJSONObject(EditorJsonConstants.EDITOR_SHAPE_PROPERTIES);
                    // 设置作者信息, 用于回显 activiti modeler 编辑模型
                    vo.setAuthor(properties.getString(StencilConstants.PROPERTY_PROCESS_AUTHOR));
                }
            }
            return vo;
        }
    
        @Override
        public void export(String id) {
            Model model = repositoryService.getModel(id);
            if (null == model) {
                throw new BusinessException("模型信息不存在");
            }
    
            // 获取流程定义文件
            byte[] modelData = repositoryService.getModelEditorSource(id);
            if (Arrays.isNullOrEmpty(modelData)) {
                throw new RuntimeException("流程模型文件不存在");
            }
            JSONObject metaInfo = JSON.parseObject(model.getMetaInfo());
            byte[] xmlBytes;
            // activiti modeler 存储的是 jsonXml, bpmn-js 存储的是 xml
            if (metaInfo.getInteger(ModelDTO.DESIGN_TYPE).equals(1)) {
                JsonNode jsonNode = null;
                try {
                    jsonNode = objectMapper.readTree(modelData);
                } catch (IOException e) {
                    throw new RuntimeException("解析流程模型文件失败");
                }
                // 使用 activiti-json-converter 依赖中的转换器将 json 转换成 BpmnModel
                BpmnModel bpmnModel = (new BpmnJsonConverter()).convertToBpmnModel(jsonNode);
                // 之后将 BpmnModel 转换成 xml
                xmlBytes = (new BpmnXMLConverter()).convertToXML(bpmnModel, StandardCharsets.UTF_8.name());
            } else {
                xmlBytes = modelData;
            }
            try {
                ByteArrayInputStream in = new ByteArrayInputStream(xmlBytes);
                HttpServletResponse response = ServletUtil.getResponse();
                IOUtils.copy(in, response.getOutputStream());
                String filename = model.getKey() + ".bpmn20.xml";
                response.setHeader("Content-Disposition", "attachment;filename=" + filename);
                response.setHeader("content-Type", "application/xml");
                response.flushBuffer();
            } catch (IOException e) {
                throw new RuntimeException("导出流程模型文件失败");
            }
        }
    
        @Override
        public boolean deployment(String id) {
            Model model = repositoryService.getModel(id);
            if (null == model) {
                throw new BusinessException("模型信息不存在");
            }
            // 构建部署对象
            DeploymentBuilder deploymentBuilder = repositoryService.createDeployment()
                    .name(model.getName()).category(model.getCategory()).key(model.getKey());
    
            // 获取流程定义文件
            byte[] modelData = repositoryService.getModelEditorSource(id);
            JSONObject metaInfo = JSON.parseObject(model.getMetaInfo());
            if (metaInfo.getInteger(ModelDTO.DESIGN_TYPE).equals(1)) {
                JsonNode jsonNode = null;
                try {
                    jsonNode = objectMapper.readTree(modelData);
                } catch (IOException e) {
                    throw new RuntimeException("解析流程模型文件失败");
                }
                // 基于 BpmnModel 部署模型
                BpmnModel bpmnModel = (new BpmnJsonConverter()).convertToBpmnModel(jsonNode);
                // 前面基础是基于 .addClasspathResource("processes/test.bpmn20.xml") 来部署的
                deploymentBuilder.addBpmnModel(model.getKey() + ".bpmn20.xml", bpmnModel);
            } else {
                // 基于 xml 部署模型
                deploymentBuilder.addBytes(model.getKey() + ".bpmn20.xml", modelData);
            }
            // 看源码发现, 如果存在多个部署名称相同的部署信息, 则会取第一个更新版本号
            Deployment deploy = null;
            try {
                deploy = deploymentBuilder.deploy();
            } catch (Exception e) {
                throw new RuntimeException("流程图不合规范，请重新设计");
            }
            model.setDeploymentId(deploy.getId());
            // 更新模型信息部署 id 字段
            repositoryService.saveModel(model);
            return true;
        }
    
        @Override
        public void saveJsonXml(JSONObject bpmnXml, String id, String name, String description, String author, int revision) {
            // 修改流程文件中的版本号 ( 这里看需求, 是以模型的版本号还是取流程设计的版本号 )
            JSONObject properties = bpmnXml.getJSONObject(EditorJsonConstants.EDITOR_SHAPE_PROPERTIES);
            if (null == properties) {
                // 配置模版属性 ( stencil properties ) , 对应设计面版上的字段
                properties = new JSONObject();
            }
            // 名称
            properties.put(StencilConstants.PROPERTY_NAME, name);
            // 描述
            properties.put(StencilConstants.PROPERTY_DOCUMENTATION, description);
            if (StringUtils.isNotEmpty(author)) {
                // 新增和编辑模型页面修改作者
                properties.put(StencilConstants.PROPERTY_PROCESS_AUTHOR, author);
            }
            // 流程唯一标识
            properties.put(StencilConstants.PROPERTY_PROCESS_ID, id);
            // 我这里是把模型的版本号作为流程设计版本号, 所以修改流程设计中的流程版本会不生效
            properties.put(StencilConstants.PROPERTY_PROCESS_VERSION, String.valueOf(revision));
            bpmnXml.put(EditorJsonConstants.EDITOR_SHAPE_PROPERTIES, properties);
            // 保存模型文件到 act_ge_bytearray 表
            repositoryService.addModelEditorSource(id, bpmnXml.toJSONString().getBytes(StandardCharsets.UTF_8));
        }
    
        @Override
        public void saveSvg(String id, String svgXml) {
            // 将 svg 图片转换为 png 保存
            InputStream svgStream = new ByteArrayInputStream(svgXml.getBytes(StandardCharsets.UTF_8));
            TranscoderInput input = new TranscoderInput(svgStream);
            // png 图片生成器
            PNGTranscoder transcoder = new PNGTranscoder();
            ByteArrayOutputStream outStream = new ByteArrayOutputStream();
            TranscoderOutput output = new TranscoderOutput(outStream);
    
            try {
                transcoder.transcode(input, output);
                final byte[] result = outStream.toByteArray();
                // 更新流程设计图片
                repositoryService.addModelEditorSourceExtra(id, result);
                outStream.close();
            } catch (TranscoderException | IOException e) {
                throw new BusinessException("更新流程设计图片异常");
            }
        }
    }
    ````

3. 请求路径配置

- 前端设计源码中接口请求路径配置文件:

  `spring-boot-activiti/web/public/activiti-explorer/editor-app/configuration/url-config.js`

    ````javascript
    KISBPM.URL = {
    
      getModel: function (modelId) {
        // 需要对应 ModelerController.getEditorJson 中的路径
        return ACTIVITI.CONFIG.contextRoot + '/modeler/json/' + modelId;
      },
    
    // 需要对应 ModelerController.getStencilSet 中的路径
      getStencilSet: function () {
        return ACTIVITI.CONFIG.contextRoot + '/modeler/stencilset?version=' + Date.now();
      },
    
    // 需要对应 ModelerController.saveDesign 中的路径
      putModel: function (modelId) {
        return ACTIVITI.CONFIG.contextRoot + '/modeler/save/' + modelId;
      }
    };
    ````

- 还有个路径配置在这个文件：

  `spring-boot-activiti/web/public/activiti-explorer/editor-app/editor/oryx.debug.js`

    ````javascript
    new Ajax.Request(ACTIVITI.CONFIG.contextRoot + '/modeler/stencilset?version=' + Date.now(), {
	            asynchronous: false,
	            method: 'get',
	            onSuccess: this._init.bind(this),
	            onFailure: this._cancelInit.bind(this)
	        });
    ````

--- 

### 测试效果

- 访问 http://localhost:30000/activiti-modeler 查看页面效果（如果页面没出来检查 modelId 是否正确）：

  ![activiti-modeler.png](..%2Fimage%2F3.5%2Factiviti-modeler.png)

- 能看到模型的相关信息能够正常回显，试一试拖拽节点，保存，查看效果。

### Bug 调试

1. 保存时报错 0.0，在 ModelerController.saveDesign 方法中，接收的参数 ModelerDTO：

    ````java
    
    @ApiModelProperty(value = "流程设计文件xml")
    private String jsonXml;
    
    @ApiModelProperty(value = "流程设计图片svg")
    private String svgXml;
    ````

- 前端模型设计那边传的参数是下划线的，阿里参数规约中 java 字段和属性名是驼峰式，修改前端传参的位置，改成驼峰，在这个文件：

  `spring-boot-activiti/web/public/activiti-explorer/editor-app/configuration/toolbar-default-actions.js`

    ````javascript
    // Parse dom to string
    var svgDOM = DataManager.serialize(svgClone);
    
    var params = {
      jsonXml: json,
      svgXml: svgDOM,
      name: $scope.saveDialog.name,
      description: $scope.saveDialog.description
    };
    // ...
    // 在最下面保存成功的时候，刷新一下页面，让其刷新一下修改后的数据
    // Execute any callback
    if (successCallback) {
      successCallback();
    }
    // 刷新页面
    location.reload()
    ````

2. 修改完，保存，打印了一个更新流程设计图片异常。0.0

   打断点看到是：Could not write PNG file because no WriteAdapter is availble（无法写入 PNG 文件，因为没有可用的
   WriteAdapter），这里缺少依赖，把 batik-codec 加上去：

    ````xml
    <batik-codec.version>1.17</batik-codec.version>
    
    <dependency>
        <groupId>org.apache.xmlgraphics</groupId>
        <artifactId>batik-codec</artifactId>
        <version>${batik-codec.version}</version>
    </dependency>
    ````

   重启，随便添加一些节点，之后保存，关闭页面后重新访问，看到节点还在就完成了：http://localhost:30000/activiti-modeler

### 模型设计

1. 添加设计按钮：

   在 model/index.vue 添加跳转按钮，让其能够跳转到刚刚完成的模型设计页面，并且带入模型 id（因为之前 id 是写死的）：

   `spring-boot-activiti/web/src/views/process/model/index.vue`

    ````vue
    <!-- 添加设计按钮 -->
    <el-button
        v-if="scope.row.designType === 1"
        icon="Document"
        @click="handlerDesign(scope.row)"
        text
        style="color: #ff9100"
    >设计(activiti-modeler)
    </el-button
    >
    
    // 点击设计按钮
    const handlerDesign = (row: ModelVO) => {
        // 跳转到模型设计页面
        window.open('/activiti-modeler?modelId=' + row.id, '_blank');
    };
    ````

   ![handlerDesign.png](..%2Fimage%2F3.5%2FhandlerDesign.png)

2. 获取路由参数：

   activiti-modeler.vue 页面把写死的 modelId 改成动态获取：

   `spring-boot-activiti/web/src/views/process/model/activiti-modeler.vue`

    ````vue
    
    <template>
      <div class='activiti-modeler-container'>
        <iframe width="100%" height="100%" :src="'/activiti-explorer/modeler.html?modelId=' + modelId"></iframe>
      </div>
    </template>
    
    <script setup lang="ts">
      import {onMounted} from 'vue';
      import {useRouter} from 'vue-router';
    
      const router = useRouter();
    
      // 从路由参数中获取 modelId
      const modelId = router.currentRoute.value.query.modelId;
    
      onMounted(() => {
        // 通过 window 对象全局挂载全局对象或者属性, 存放在内存刷新会清空, 这并不是推荐的做法, 因为直接修改全局对象可能会导致命名冲突, 难以进行模块化管理以及不利于应用的封装与维护
        window.$contextRoot = import.meta.env.VITE_APP_BASE_API;
    
      });
    
    </script>
    ````

   到这，整合 activiti-modeler 差不多完成了，为什么是差不多？有的地方还没有完全汉化。0.0，比如这里的保存模型还显示的英文

   ![saveModel.png](..%2Fimage%2F3.5%2FsaveModel.png)

3. 汉化:

   这里的语言文件和之前配置的 stencilset-zh.json 不是用一个，对应的文件在：

   `editor-app/i18n/en.json`

- 应该添加一个 zh.json 文件，然后加载，看了一下好像有点麻烦，0.0，这里就直接改 en.json 里面的内容了

  ![en-json.png](..%2Fimage%2F3.5%2Fen-json.png)

  我这里随便改了几个常用的，有点多改不动。

  ![saveModelZh.png](..%2Fimage%2F3.5%2FsaveModelZh.png)

4. 保存并关闭：

   保存并关闭没有跳转回原系统，看源码：

   `editor-app/popups/save-model.html`

    ````html
    
    <button class="btn btn-primary" ng-click="saveAndClose()" ng-disabled="status.loading" ng-show="!error" translate>
      ACTION.SAVE-AND-CLOSE
    </button>
    ````

   这个是保存并关闭的按钮，调用的是 saveAndClose，全局搜索一下：

   `editor-app/configuration/toolbar-default-actions.js`

    ````javascript
    $scope.saveAndClose = function () {
      $scope.save(function () {
        // 这里是保存成功的回调函数, 看是跳转到系统模型管理页面还是关闭当前页面
        // window.location.href = "./";
        // 跳转到模型设计页面路由
        // window.location.href = '/process/model';
        // 关闭当前窗口页面
        window.parent.close();
      });
    };
    ````

---

## 二、Model 接口字段补充

**补充字段 description, author 和 designType**

想了一下，在 model/index 和 model/form-model 中都加上 description/author/designType 字段显示和编辑，一开始没加的原因是描述是存储在
metaInfo 中，而 author 存储在模型文件中，有点麻烦，列表需要处理一下描述和设计类型回显，编辑的时候需要处理作者的回显

- 列表回显：

  model/index.vue 在表格配置中添加一个 description 字段：

  `spring-boot-activiti/web/src/views/process/model/index.vue`

    ````typescript
    // 表格列配置
    const columns = reactive<Column[]>([
      // ...
      {
        prop: 'description',
        label: '模型描述',
        width: 180
      },
      {
        prop: 'designType',
        label: '设计类型',
        option: [
          {
            value: 1,
            label: 'activiti-modeler',
            tagType: 'success'
          },
          {
            value: 2,
            label: 'bpmn-js',
            tagType: 'warning'
          },
        ],
        width: 240
      },
    ]);
    ````

- form-model.vue 添加作者、设计类型和描述 input：

  `spring-boot-activiti/web/src/views/process/model/form-model.vue`

    ````vue
    
    <el-form-item label="模型设计类型" prop="type">
      <el-radio-group v-model="form.designType">
        <el-radio :key="1" :label="1">activiti-modeler</el-radio>
        <el-radio :key="2" :label="2">bpmn-js</el-radio>
      </el-radio-group>
    </el-form-item>
    <el-form-item label="模型描述" prop="description">
      <el-input v-model="form.description" placeholder="请输入模型描述"></el-input>
    </el-form-item>
    <!-- 只有 activiti-modeler 才需要填写作者，bpmn-js 没有 properties 属性 -->
    <el-form-item v-if="form.designType === 1" label="模型作者" prop="author">
      <el-input v-model="form.author" placeholder="请输入模型作者"></el-input>
    </el-form-item>
    ````

- 整合 activiti-modeler 基本都完成了，尽量把整合到项目中需要修改的点都罗列出来，可能还会有一些遗漏的没写在文档里面，
  边敲代码边写感觉会漏掉，报错的话可以对照代码看一下，后面来整合 bpmn-js

---

## 三、Vue3 整合 bpmn-js

- 官网：

https://bpmn.io/

- 仓库：

https://github.com/bpmn-io/bpmn-js

- 整合所用到的依赖，可以全部安装，也可以跟着步骤逐一安装测试

**npm 方式添加**

````shell
# bpmn-js                         画布流程渲染
# bpmn-js-properties-panel        右侧属性栏
# diagram-js-minimap              小地图
npm install bpmn-js bpmn-js-properties-panel diagram-js-minimap
````

**yarn 方式添加**

````shell
yarn add bpmn-js bpmn-js-properties-panel diagram-js-minimap
````

1. bpmn-js 画布和渲染：

- 安装 bpmn-js，测试画布和左侧工具栏，注意安装的版本，不指定版本号的话，默认最新版，我安装的时候版本是 17.11.1

  可以看一下依赖中的 node_modules/bpmn-js/README.md 文件，有相关示例

````shell
# 安装最新版, 两种安装方式执行一个就行
npm install bpmn-js
# yarn add bpmn-js

# 指定版本安装：
# npm install bpmn-js@17.11.1
# yarn add bpmn-js@17.11.1
````

- 添加页面

`spring-boot-activiti/web/src/views/process/model/bpmn-js.vue`

````vue

<template>
  <div class='bpmn-js-container'>
    <!-- 画布 -->
    <div class="canvas" ref="canvasRef" id="canvas"/>

    <!-- 操作 -->
    <div class="operate">
      <el-button class="operate-item" size="small" icon="el-icon-search" @click="handlerSave">
        保存
      </el-button>
      <el-button class="operate-item" size="small" icon="el-icon-search" @click="handlerSave(true)">
        保存并关闭
      </el-button>
    </div>
  </div>
</template>

<script setup lang="ts">
  import {markRaw, onMounted, ref} from 'vue';
  // 设计器
  import BpmnModeler from 'bpmn-js/lib/Modeler';
  // 左边工具栏以及编辑节点的样式
  import 'bpmn-js/dist/assets/diagram-js.css';
  // 工具栏字体图标样式
  import 'bpmn-js/dist/assets/bpmn-font/css/bpmn-embedded.css';

  // 挂载画布
  const canvasRef = ref();
  // 设计器实例
  const bpmnModeler = ref();

  onMounted(() => {
    // 初始化
    init();
    // 预览
    preview();
  });

  // 初始化实例
  const init = () => {
    // toRaw 方法可以将一个被 reactive 包裹的对象还原为其中的原始对象，从而使其不再具有任何响应式能力。
    // markRaw 方法可以将一个对象标记为非响应式，从而使其不会被 reactive 包裹，也就不会成为 Vue3 中的响应式对象。
    // BpmnViewer 预览、BpmnModeler 操作
    bpmnModeler.value = markRaw(new BpmnModeler({
      // 画布
      container: canvasRef.value
    }));
    const canvas = bpmnModeler.value.get('canvas');
    // 设置画布背景色
    canvas._container.style.backgroundColor = '#f2f2f2';
  };

  // 预览
  const preview = () => {
    // 先写死一个 xml 来渲染测试, 这个 xml 是之前用 idea 插件画的 resources/processes/test.bpmn20.xml
    const xmlString = `<?xml version="1.0" encoding="UTF-8"?><definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:activiti="http://activiti.org/bpmn" targetNamespace="http://www.activiti.org/processdef"><process id="test" name="test" isExecutable="true"><startEvent id="sid-e8a69d3a-e0fe-4728-b1aa-cc6e967ad749" /><userTask id="sid-9002d505-244f-420a-bd96-39f96f40c49a" name="提交申请" /><userTask id="sid-cb3c722b-808f-4932-98ca-aab433c4da25" name="领导审批" /><endEvent id="sid-1918ce19-1394-40d8-b0a6-a661e89ef42d" /><sequenceFlow id="sid-1104d862-1837-474b-bc68-77ae330abca9" sourceRef="sid-e8a69d3a-e0fe-4728-b1aa-cc6e967ad749" targetRef="sid-9002d505-244f-420a-bd96-39f96f40c49a" /><sequenceFlow id="sid-5ddc1d3b-f32b-4eb8-99bd-3fb170ad495f" sourceRef="sid-9002d505-244f-420a-bd96-39f96f40c49a" targetRef="sid-cb3c722b-808f-4932-98ca-aab433c4da25" /><sequenceFlow id="sid-bb10ac4b-83ec-48df-9dd4-2b5edc7f5507" sourceRef="sid-cb3c722b-808f-4932-98ca-aab433c4da25" targetRef="sid-1918ce19-1394-40d8-b0a6-a661e89ef42d" /></process><bpmndi:BPMNDiagram id="BPMNDiagram_test"><bpmndi:BPMNPlane id="BPMNPlane_test" bpmnElement="test"><bpmndi:BPMNShape id="shape-31f6eace-2180-4508-8c59-8134d4ba2305" bpmnElement="sid-9002d505-244f-420a-bd96-39f96f40c49a"><omgdc:Bounds x="880" y="357" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="shape-19af1961-8fd8-45bf-a7ff-f0c5078d9277" bpmnElement="sid-cb3c722b-808f-4932-98ca-aab433c4da25"><omgdc:Bounds x="1080" y="357" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="shape-dde69d06-7654-4b35-b2c3-ffbb12f2a5a8" bpmnElement="sid-1918ce19-1394-40d8-b0a6-a661e89ef42d"><omgdc:Bounds x="1280" y="382" width="30" height="30" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="shape-6b082d8d-d467-4359-8834-114f9362d628" bpmnElement="sid-e8a69d3a-e0fe-4728-b1aa-cc6e967ad749"><omgdc:Bounds x="725" y="382" width="30" height="30" /></bpmndi:BPMNShape><bpmndi:BPMNEdge id="edge-f1ae40a2-95e4-4006-b001-83376f57baa9" bpmnElement="sid-1104d862-1837-474b-bc68-77ae330abca9"><omgdi:waypoint x="755" y="397" /><omgdi:waypoint x="880" y="397" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="edge-67f619bc-02a6-4323-8eb8-60df8ee1497a" bpmnElement="sid-5ddc1d3b-f32b-4eb8-99bd-3fb170ad495f"><omgdi:waypoint x="980" y="397" /><omgdi:waypoint x="1080" y="397" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="edge-ba818e30-4fff-42b6-8520-a52fc90ec7c5" bpmnElement="sid-bb10ac4b-83ec-48df-9dd4-2b5edc7f5507"><omgdi:waypoint x="1180" y="397" /><omgdi:waypoint x="1280" y="397" /></bpmndi:BPMNEdge></bpmndi:BPMNPlane></bpmndi:BPMNDiagram></definitions>`;
    // 渲染流程图
    bpmnModeler.value.importXML(xmlString);
  };

  const handlerSave = async (close?: boolean) => {
    // 可以点保存查看下控制台 xml
    const {xml} = await bpmnModeler.value.saveXML();
    console.log('handlerSave: ', xml);
  };
</script>

<style scoped lang='scss'>
  .bpmn-js-container {
    #canvas {
      width: 100vw;
      height: 100vh;
      border: 1px solid #c0c0c0;
    }

    /* 操作 */
    .operate {
      position: absolute;
      right: 10px;
      bottom: 100px;
      padding: 10px;

      .operate-item {
        width: 110px;
        margin: 10px;
        background: rgb(255, 255, 255);
        color: black;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
        border-radius: 6px;
      }
    }
  }

</style>
````

- 添加路由配置：

````typescript
// 公共静态路由
const constantRoutes = [
  // ...
  {
    path: '/bpmn-js',
    component: () => import ('@/views/process/model/bpmn-js.vue'),
    name: 'bpmn-js 模型设计'
  },
];
````

查看使用的 xml 是否能正常渲染 http://localhost:30000/bpmn-js

![bpmn-js.png](..%2Fimage%2F3.5%2Fbpmn-js.png)

2. bpmn-js-properties-panel 右侧属性栏：

- 安装 bpmn-js-properties-panel

````shell
# 安装最新版, 两种安装方式执行一个就行
npm install bpmn-js-properties-panel
# yarn add bpmn-js-properties-panel
````

**注意**

网上的教程都是引入这个, 不过版本都是 0.+ 的, 我这里安装的版本是 "bpmn-js-properties-panel": "^5.25.0", 对应的目录没有这个文件

`import 'bpmn-js-properties-panel/dist/assets/bpmn-js-properties-panel.css';`

看他源码 bpmn-js-properties-panel/package.json 里面导入了 "@bpmn-io/properties-panel": "^3.24.1", 我就找到了下面这个
css, 发现可以渲染属性栏样式

`import '@bpmn-io/properties-panel/dist/assets/properties-panel.css';`

- ts 类型声明

`spring-boot-activiti/web/src/types/global.d.ts`

````typescript
// 属性栏模块包类型
declare module 'bpmn-js-properties-panel';
````

- 修改 bpmn-js.vue 页面，添加 bpmn-js-properties-panel 属性栏

`spring-boot-activiti/web/src/views/process/model/bpmn-js.vue`

````vue

<template>
  <div class='bpmn-js-container'>
    <div class="bpmn-js-wrapper">
      <!-- 画布 -->
      <div class="canvas" ref="canvasRef" id="canvas"/>

      <!-- 属性工具栏 -->
      <div id="properties-panel"></div>

      <!-- 操作 -->
      <div class="operate">
        <el-button class="operate-item" size="small" icon="DocumentAdd" @click="handlerSave">
          保存
        </el-button>
        <el-button class="operate-item" size="small" icon="DocumentAdd" @click="handlerSave(true)">
          保存并关闭
        </el-button>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
  import {markRaw, onMounted, ref} from 'vue';
  // 设计器, bpmn-js有两种模式: Modeler 模式和 Viewer 模式, 在 Modeler 模式下可以对流程图进行编辑, 而 Viewer 模式则不能, 仅作为展示用
  import BpmnModeler from 'bpmn-js/lib/Modeler';
  // 左侧工具栏以及选中节点的样式,
  import 'bpmn-js/dist/assets/diagram-js.css';
  // 这个不知道啥效果, 看样式是类名有 .bjs-container .bjs-breadcrumbs, 内容和面包屑样式? 后面看看会不会找到用的地方
  import 'bpmn-js/dist/assets/bpmn-js.css';

  // 左侧工具栏字体图标样式
  import 'bpmn-js/dist/assets/bpmn-font/css/bpmn.css';
  // 这个是一些 unicode 码, 生僻字不知道干啥的 0.0
  import 'bpmn-js/dist/assets/bpmn-font/css/bpmn-codes.css';
  // 这个比 bpmn.css  多了两个 src base64
  import 'bpmn-js/dist/assets/bpmn-font/css/bpmn-embedded.css';
  import {
    BpmnPropertiesPanelModule,
    BpmnPropertiesProviderModule,
    CamundaPlatformPropertiesProviderModule
  } from 'bpmn-js-properties-panel';
  // 扩展属性
  import CamundaModdleDescriptor from 'camunda-bpmn-moddle/resources/camunda'

  // 网上的教程都是引入这个, 不过版本都是 0.+ 的, 我这里安装的版本是 "bpmn-js-properties-panel": "^5.25.0", 对应的目录没有这个文件
  // import 'bpmn-js-properties-panel/dist/assets/bpmn-js-properties-panel.css';
  // 看他源码的 package.json 里面导入了 "@bpmn-io/properties-panel": "^3.24.1", 我就找到了下面这个 css, 发现可以渲染属性栏样式
  import '@bpmn-io/properties-panel/dist/assets/properties-panel.css';

  // 挂载画布
  const canvasRef = ref();
  // 设计器实例
  const bpmnModeler = ref();

  onMounted(() => {
    // 初始化
    init();
    // 预览
    preview();
  });

  // 初始化实例
  const init = () => {
    // toRaw 方法可以将一个被 reactive 包裹的对象还原为其中的原始对象，从而使其不再具有任何响应式能力。
    // markRaw 方法可以将一个对象标记为非响应式，从而使其不会被 reactive 包裹，也就不会成为 Vue3 中的响应式对象。
    // BpmnViewer 预览、BpmnModeler 操作
    bpmnModeler.value = markRaw(new BpmnModeler({
      // 画布
      container: canvasRef.value,

      // 属性工具栏
      propertiesPanel: {
        parent: '#properties-panel'
      },

      additionalModules: [
        BpmnPropertiesPanelModule,
        // 基础信息, id/name/version
        BpmnPropertiesProviderModule,
        // 属性扩展
        CamundaPlatformPropertiesProviderModule
      ],
      // 扩展属性
      moddleExtensions: {
        camunda: CamundaModdleDescriptor
      }
    }));
    const canvas = bpmnModeler.value.get('canvas');
    // 设置画布背景色
    canvas._container.style.backgroundColor = '#f2f2f2';
  };

  // 预览
  const preview = () => {
    // 先写死一个 xml 来渲染测试, 这个 xml 是之前用 idea 插件画的 resources/processes/test.bpmn20.xml
    const xmlString = `<?xml version="1.0" encoding="UTF-8"?><definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:activiti="http://activiti.org/bpmn" targetNamespace="http://www.activiti.org/processdef"><process id="test" name="test" isExecutable="true"><startEvent id="sid-e8a69d3a-e0fe-4728-b1aa-cc6e967ad749" /><userTask id="sid-9002d505-244f-420a-bd96-39f96f40c49a" name="提交申请" /><userTask id="sid-cb3c722b-808f-4932-98ca-aab433c4da25" name="领导审批" /><endEvent id="sid-1918ce19-1394-40d8-b0a6-a661e89ef42d" /><sequenceFlow id="sid-1104d862-1837-474b-bc68-77ae330abca9" sourceRef="sid-e8a69d3a-e0fe-4728-b1aa-cc6e967ad749" targetRef="sid-9002d505-244f-420a-bd96-39f96f40c49a" /><sequenceFlow id="sid-5ddc1d3b-f32b-4eb8-99bd-3fb170ad495f" sourceRef="sid-9002d505-244f-420a-bd96-39f96f40c49a" targetRef="sid-cb3c722b-808f-4932-98ca-aab433c4da25" /><sequenceFlow id="sid-bb10ac4b-83ec-48df-9dd4-2b5edc7f5507" sourceRef="sid-cb3c722b-808f-4932-98ca-aab433c4da25" targetRef="sid-1918ce19-1394-40d8-b0a6-a661e89ef42d" /></process><bpmndi:BPMNDiagram id="BPMNDiagram_test"><bpmndi:BPMNPlane id="BPMNPlane_test" bpmnElement="test"><bpmndi:BPMNShape id="shape-31f6eace-2180-4508-8c59-8134d4ba2305" bpmnElement="sid-9002d505-244f-420a-bd96-39f96f40c49a"><omgdc:Bounds x="880" y="357" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="shape-19af1961-8fd8-45bf-a7ff-f0c5078d9277" bpmnElement="sid-cb3c722b-808f-4932-98ca-aab433c4da25"><omgdc:Bounds x="1080" y="357" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="shape-dde69d06-7654-4b35-b2c3-ffbb12f2a5a8" bpmnElement="sid-1918ce19-1394-40d8-b0a6-a661e89ef42d"><omgdc:Bounds x="1280" y="382" width="30" height="30" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="shape-6b082d8d-d467-4359-8834-114f9362d628" bpmnElement="sid-e8a69d3a-e0fe-4728-b1aa-cc6e967ad749"><omgdc:Bounds x="725" y="382" width="30" height="30" /></bpmndi:BPMNShape><bpmndi:BPMNEdge id="edge-f1ae40a2-95e4-4006-b001-83376f57baa9" bpmnElement="sid-1104d862-1837-474b-bc68-77ae330abca9"><omgdi:waypoint x="755" y="397" /><omgdi:waypoint x="880" y="397" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="edge-67f619bc-02a6-4323-8eb8-60df8ee1497a" bpmnElement="sid-5ddc1d3b-f32b-4eb8-99bd-3fb170ad495f"><omgdi:waypoint x="980" y="397" /><omgdi:waypoint x="1080" y="397" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="edge-ba818e30-4fff-42b6-8520-a52fc90ec7c5" bpmnElement="sid-bb10ac4b-83ec-48df-9dd4-2b5edc7f5507"><omgdi:waypoint x="1180" y="397" /><omgdi:waypoint x="1280" y="397" /></bpmndi:BPMNEdge></bpmndi:BPMNPlane></bpmndi:BPMNDiagram></definitions>`;
    // 渲染流程图
    bpmnModeler.value.importXML(xmlString);
  };

  const handlerSave = async (close?: boolean) => {
    // 可以点保存查看下控制台 xml
    const {xml} = await bpmnModeler.value.saveXML();
    console.log('handlerSave: ', xml);
  };
</script>

<style scoped lang='scss'>
  .bpmn-js-container {

    width: 100vw;
    height: 100vh;
    // 画布加个空白边距
    padding: 10px;
    // 将 border 和 padding 数值包含在 width 和 height 之内
    box-sizing: border-box;

    .bpmn-js-wrapper {

      height: 100%;
      position: relative;

      #canvas {
        height: 100%;
        border: 1px solid #c0c0c0;
      }

      /* 右侧面板样式 */
      #properties-panel {
        position: absolute;
        top: 5px;
        right: 5px;
      }

      /* 操作 */
      .operate {
        position: absolute;
        right: 50px;
        bottom: 100px;

        .operate-item {
          padding: 15px;
          width: 110px;
          margin: 10px;
          background: rgb(255, 255, 255);
          color: black;
          box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
          border-radius: 6px;

          &:hover {
            color: deepskyblue;
          }
        }
      }
    }
  }

</style>
````

效果：

![bpmn-js-properties-panel.png](..%2Fimage%2F3.5%2Fbpmn-js-properties-panel.png)

3. diagram-js-minimap 小地图：

开源仓库有说明文档：https://github.com/PL-FE/bpmn-doc/blob/main/doc/customMiniMap.md

- 安装 diagram-js-minimap

````shell
# 安装最新版, 两种安装方式执行一个就行
npm install diagram-js-minimap
# yarn add diagram-js-minimap
````

- ts 类型声明

`spring-boot-activiti/web/src/types/global.d.ts`

````typescript
// 小地图模块包类型
declare module 'diagram-js-minimap';
````

- 导入小地图并且添加模块：

````
// 小地图
import minimapModule from 'diagram-js-minimap';
import 'diagram-js-minimap/assets/diagram-js-minimap.css';

additionalModules: [
  // 右侧属性栏属性标题
  // ...
  minimapModule
]

.bpmn-js-wrapper {
    // 覆盖默认样式, 把小地图往左边挪点, 不然会被右侧属性栏挡住
    ::v-deep(.djs-minimap) {
      right: 580px !important;
    }
}
````

效果：

![diagram-js-minimap.png](..%2Fimage%2F3.5%2Fdiagram-js-minimap.png)

三个依赖都集成完成了，把英文转换一下：

4. 添加语言包转换工具：

`spring-boot-activiti/web/src/utils/translate.ts`

````typescript
/**
 * https://github.com/bpmn-io/bpmn-js-i18n/blob/main/translations/zn.js
 */
const translations: { [key: string]: string } = {
    'Activate create/remove space tool': '启动创建/删除空间工具',
    'Activate global connect tool': '启动全局连接工具',
    'Activate hand tool': '启动手动工具',
    'Activate lasso tool': '启动 Lasso 工具',
    'Ad-hoc': 'Ad-hoc子流程',
    'Add lane above': '添加到通道之上',
    'Add lane below': '添加到通道之下',
    'Append compensation activity': '追加补偿活动',
    'Append conditional intermediate catch event': '添加中间条件捕获事件',
    'Append end event': '添加结束事件',
    'Append gateway': '添加网关',
    'Append intermediate/boundary event': '添加中间/边界事件',
    'Append message intermediate catch event': '添加消息中间捕获事件',
    'Append receive task': '添加接收任务',
    'Append signal intermediate catch event': '添加信号中间捕获事件',
    'Append task': '添加任务',
    'Append timer intermediate catch event': '添加定时器中间捕获事件',
    'Business rule task': '规则任务',
    'Call activity': '引用流程',
    'Cancel boundary event': '取消边界事件',
    'Cancel end event': '取消结束事件',
    'Change type': '更改类型',
    'Collection': '集合',
    'Compensation boundary event': '补偿边界事件',
    'Compensation end event': '结束补偿事件',
    'Compensation intermediate throw event': '中间补偿抛出事件',
    'Compensation start event': '补偿启动事件',
    'Complex gateway': '复杂网关',
    'Conditional boundary event': '条件边界事件',
    'Conditional boundary event (non-interrupting)': '条件边界事件 (非中断)',
    'Conditional flow': '条件流',
    'Conditional intermediate catch event': '中间条件捕获事件',
    'Conditional start event': '条件启动事件',
    'Conditional start event (non-interrupting)': '条件启动事件 (非中断)',
    'Connect using association': '文本关联',
    'Connect using data input association': '数据关联',
    'Connect using sequence/message flow or association': '消息关联',
    'Create data object reference': '创建数据对象引用',
    'Create data store reference': '创建数据存储引用',
    'Create end event': '创建结束事件',
    'Create expanded sub-process': '创建可折叠子流程',
    'Create gateway': '创建网关',
    'Create group': '创建组',
    'Create intermediate/boundary event': '创建中间/边界事件',
    'Create pool/participant': '创建池/参与者',
    'Create start event': '创建开始事件',
    'Create task': '创建任务',
    'Data object reference': '数据对象引用',
    'Data store reference': '数据存储引用',
    'Default flow': '默认流',
    'Divide into three lanes': '分成三条通道',
    'Divide into two lanes': '分成两条通道',
    'Empty pool/participant': '空泳道',
    'Empty pool/participant (removes content)': '清空泳道（删除内容）',
    'End event': '结束事件',
    'Error boundary event': '错误边界事件',
    'Error end event': '结束错误事件',
    'Error start event': '错误启动事件',
    'Escalation boundary event': '升级边界事件',
    'Escalation boundary event (non-interrupting)': '升级边界事件 (非中断)',
    'Escalation end event': '结束升级事件',
    'Escalation intermediate throw event': '中间升级抛出事件',
    'Escalation start event': '升级启动事件',
    'Escalation start event (non-interrupting)': '升级启动事件 (非中断)',
    'Event sub-process': '事件子流程',
    'Event-based gateway': '事件网关',
    'Exclusive gateway': '独占网关',
    'Inclusive gateway': '包容网关',
    'Intermediate throw event': '中间抛出事件',
    'Link intermediate catch event': '中间链接捕获事件',
    'Link intermediate throw event': '中间链接抛出事件',
    'Loop': '循环',
    'Manual task': '手动任务',
    'Message boundary event': '消息边界事件',
    'Message boundary event (non-interrupting)': '消息边界事件 (非中断)',
    'Message end event': '结束消息事件',
    'Message intermediate catch event': '中间消息捕获事件',
    'Message intermediate throw event': '中间消息抛出事件',
    'Message start event': '消息启动事件',
    'Message start event (non-interrupting)': '消息启动事件 (非中断)',
    'Parallel gateway': '并行网关',
    'Parallel multi-instance': '并行多实例',
    'Participant multiplicity': '参与者多重性',
    'Receive task': '接受任务',
    'Remove': '移除',
    'Script task': '脚本任务',
    'Send task': '发送任务',
    'Sequence flow': '顺序流',
    'Sequential multi-instance': '串行多实例',
    'Service task': '服务任务',
    'Signal boundary event': '信号边界事件',
    'Signal boundary event (non-interrupting)': '信号边界事件 (非中断)',
    'Signal end event': '结束信号事件',
    'Signal intermediate catch event': '中间信号捕获事件',
    'Signal intermediate throw event': '中间信号抛出事件',
    'Signal start event': '信号启动事件',
    'Signal start event (non-interrupting)': '信号启动事件 (非中断)',
    'Start event': '开始事件',
    'Sub-process': '子流程',
    'Sub-process (collapsed)': '可折叠子流程',
    'Sub-process (expanded)': '可展开子流程',
    'Task': '任务',
    'Terminate end event': '终止边界事件',
    'Timer boundary event': '定时边界事件',
    'Timer boundary event (non-interrupting)': '定时边界事件 (非中断)',
    'Timer intermediate catch event': '中间定时捕获事件',
    'Timer start event': '定时启动事件',
    'Timer start event (non-interrupting)': '定时启动事件 (非中断)',
    'Transaction': '事务',
    'User task': '用户任务',
    'already rendered {element}': '{element} 已呈现',
    'correcting missing bpmnElement on {plane} to {rootElement}': '在 {plane} 上更正缺失的 bpmnElement 为 {rootElement}',
    'diagram not part of bpmn:Definitions': '图表不是 bpmn:Definitions 的一部分',
    'element required': '需要元素',
    'element {element} referenced by {referenced}#{property} not yet drawn': '元素 {element} 的引用 {referenced}#{property} 尚未绘制',
    'failed to import {element}': '{element} 导入失败',
    'flow elements must be children of pools/participants': '元素必须是池/参与者的子级',
    'missing {semantic}#attachedToRef': '在 {element} 中缺少 {semantic}#attachedToRef',
    'more than {count} child lanes': '超过 {count} 条通道',
    'multiple DI elements defined for {element}': '为 {element} 定义了多个 DI 元素',
    'no bpmnElement referenced in {element}': '{element} 中没有引用 bpmnElement',
    'no diagram to display': '没有要显示的图表',
    'no parent for {element} in {parent}': '在 {element} 中没有父元素 {parent}',
    'no process or collaboration to display': '没有可显示的流程或协作',
    'no shape type specified': '未指定形状类型',
    'out of bounds release': '越界释放',

    // Labels
    'Activate the global connect tool': '激活全局连接工具',
    'Append {type}': '追加 {type}',
    'Append EndEvent': '追加 结束事件 ',
    'Append Task': '追加 任务',
    'Append Gateway': '追加 网关',
    'Append Intermediate/Boundary Event': '追加 中间/边界 事件',
    'Add Lane above': '在上面添加道',
    'Divide into two Lanes': '分割成两个道',
    'Divide into three Lanes': '分割成三个道',
    'Add Lane below': '在下面添加道',
    'Connect using Association': '使用关联连接',
    'Connect using Sequence/MessageFlow or Association': '使用顺序/消息流或者关联连接',
    'Connect using DataInputAssociation': '使用数据输入关联连接',
    'Activate the hand tool': '激活抓手工具',
    'Activate the lasso tool': '激活套索工具',
    'Activate the create/remove space tool': '激活创建/删除空间工具',
    'Create expanded SubProcess': '创建扩展子过程',
    'Create IntermediateThrowEvent/BoundaryEvent': '创建中间抛出事件/边界事件',
    'Create Pool/Participant': '创建池/参与者',
    'Parallel Multi Instance': '并行多重事件',
    'Sequential Multi Instance': '时序多重事件',
    'DataObjectReference': '数据对象参考',
    'DataStoreReference': '数据存储参考',
    'Create {type}': '创建 {type}',
    'Create Task': '创建任务',
    'Create StartEvent': '创建开始事件',
    'Create EndEvent': '创建结束事件',
    'Create Group': '创建组',
    'Send Task': '发送任务',
    'Receive Task': '接收任务',
    'User Task': '用户任务',
    'Manual Task': '手工任务',
    'Business Rule Task': '业务规则任务',
    'Service Task': '服务任务',
    'Script Task': '脚本任务',
    'Call Activity': '调用活动',
    'Sub Process (collapsed)': '子流程（折叠的）',
    'Sub Process (expanded)': '子流程（展开的）',
    'Start Event': '开始事件',
    'StartEvent': '开始事件',
    'Intermediate Throw Event': '中间事件',
    'End Event': '结束事件',
    'EndEvent': '结束事件',
    'Create Gateway': '创建网关',
    'GateWay': '网关',
    'Create Intermediate/Boundary Event': '创建中间/边界事件',
    'Message Start Event': '消息开始事件',
    'Timer Start Event': '定时开始事件',
    'Conditional Start Event': '条件开始事件',
    'Signal Start Event': '信号开始事件',
    'Error Start Event': '错误开始事件',
    'Escalation Start Event': '升级开始事件',
    'Compensation Start Event': '补偿开始事件',
    'Message Start Event (non-interrupting)': '消息开始事件（非中断）',
    'Timer Start Event (non-interrupting)': '定时开始事件（非中断）',
    'Conditional Start Event (non-interrupting)': '条件开始事件（非中断）',
    'Signal Start Event (non-interrupting)': '信号开始事件（非中断）',
    'Escalation Start Event (non-interrupting)': '升级开始事件（非中断）',
    'Message Intermediate Catch Event': '消息中间捕获事件',
    'Message Intermediate Throw Event': '消息中间抛出事件',
    'Timer Intermediate Catch Event': '定时中间捕获事件',
    'Escalation Intermediate Throw Event': '升级中间抛出事件',
    'Conditional Intermediate Catch Event': '条件中间捕获事件',
    'Link Intermediate Catch Event': '链接中间捕获事件',
    'Link Intermediate Throw Event': '链接中间抛出事件',
    'Compensation Intermediate Throw Event': '补偿中间抛出事件',
    'Signal Intermediate Catch Event': '信号中间捕获事件',
    'Signal Intermediate Throw Event': '信号中间抛出事件',
    'Message End Event': '消息结束事件',
    'Escalation End Event': '定时结束事件',
    'Error End Event': '错误结束事件',
    'Cancel End Event': '取消结束事件',
    'Compensation End Event': '补偿结束事件',
    'Signal End Event': '信号结束事件',
    'Terminate End Event': '终止结束事件',
    'Message Boundary Event': '消息边界事件',
    'Message Boundary Event (non-interrupting)': '消息边界事件（非中断）',
    'Timer Boundary Event': '定时边界事件',
    'Timer Boundary Event (non-interrupting)': '定时边界事件（非中断）',
    'Escalation Boundary Event': '升级边界事件',
    'Escalation Boundary Event (non-interrupting)': '升级边界事件（非中断）',
    'Conditional Boundary Event': '条件边界事件',
    'Conditional Boundary Event (non-interrupting)': '条件边界事件（非中断）',
    'Error Boundary Event': '错误边界事件',
    'Cancel Boundary Event': '取消边界事件',
    'Signal Boundary Event': '信号边界事件',
    'Signal Boundary Event (non-interrupting)': '信号边界事件（非中断）',
    'Compensation Boundary Event': '补偿边界事件',
    'Exclusive Gateway': '互斥网关',
    'Parallel Gateway': '并行网关',
    'Inclusive Gateway': '相容网关',
    'Complex Gateway': '复杂网关',
    'Event based Gateway': '事件网关',
    'Sub Process': '子流程',
    'Event Sub Process': '事件子流程',
    'Collapsed Pool': '折叠池',
    'Expanded Pool': '展开池',

    // 属性面板的参数
    'Process': '流程',
    'Id': '编号',
    'Name': '名称',
    'Version tag': '版本标记',
    'General': '常规',
    'Details': '详情',
    'Message Name': '消息名称',
    'Message': '消息',
    'Initiator': '创建者',
    'Create': '创建',
    'Asynchronous continuations': '持续异步',
    'Before': '异步前',
    'After': '异步后',
    'Job Configuration': '工作配置',
    'Exclusive': '排除',
    'Job Priority': '工作优先级',
    'Job execution': '工作执行',
    'Retry Time Cycle': '重试时间周期',
    'Documentation': '文档',
    'Element documentation': '元素文档',
    'History cleanup': '历史记录清理',
    'Time to live': '生存时间',
    'Forms': '表单',
    'Form Key': '表单key',
    'Form Fields': '表单字段',
    'Business Key': '业务key',
    'Form Field': '表单字段',
    'ID': '编号',
    'Type': '类型',
    'Label': '名称',
    'Default Value': '默认值',
    'Validation': '校验',
    'Add Constraint': '添加约束',
    'Config': '配置',
    'Properties': '属性',
    'Add Property': '添加属性',
    'Value': '值',
    'Add': '添加',
    'Values': '值',
    'Add Value': '添加值',
    'Listeners': '监听器',
    'Execution listeners': '执行监听',
    'Extension properties': '扩展属性',
    'Event type': '事件类型',
    'Listener type': '监听器类型',
    'Java Class': 'Java类',
    'Expression': '表达式',
    'Must provide a value': '必须提供一个值',
    'Delegate Expression': '代理表达式',
    'Script': '脚本',
    'Script Format': '脚本格式',
    'Script Type': '脚本类型',
    'Inline Script': '内联脚本',
    'External Script': '外部脚本',
    'Resource': '资源',
    'Field injection': '字段注入',
    'Extensions': '扩展',
    'Input/Output': '输入/输出',
    'Input Parameters': '输入参数',
    'Inputs': '输入参数',
    'Output Parameters': '输出参数',
    'Parameters': '参数',
    'Output Parameter': '输出参数',
    'Outputs': '输出参数',
    'Timer Definition Type': '定时器定义类型',
    'Timer Definition': '定时器定义',
    'Date': '日期',
    'Duration': '持续',
    'Cycle': '循环',
    'Signal': '信号',
    'Signal Name': '信号名称',
    'Escalation': '升级',
    'Error': '错误',
    'Link Name': '链接名称',
    'Condition': '条件名称',
    'Variable Name': '变量名称',
    'Local variable name': '局部变量名称',
    'Process variable name': '流程变量名称',
    'Assignment type': '分配类型',
    'Variable Event': '变量事件',
    'Specify more than one variable change event as a comma separated list.': '多个变量事件以逗号隔开',
    'Wait for Completion': '等待完成',
    'Activity Ref': '活动参考',
    'Version Tag': '版本标签',
    'Executable': '可执行文件',
    'External task': '扩展任务配置',
    'Task Priority': '任务优先级',
    'External': '外部',
    'Connector': '连接器',
    'Must configure Connector': '必须配置连接器',
    'Connector Id': '连接器编号',
    'Implementation': '实现方式',
    'Field Injections': '字段注入',
    'Fields': '字段',
    'Result Variable': '结果变量',
    'Topic': '主题',
    'Configure Connector': '配置连接器',
    'Input Parameter': '输入参数',
    'Assignee': '代理人',
    'User assignment': '用户分配',
    'Candidate users': '候选用户',
    'Candidate groups': '候选组',
    'Due date': '到期时间',
    'Follow up date': '跟踪日期',
    'Priority': '优先级',
    'The follow up date as an EL expression (e.g. ${someDate}) or an ISO date (e.g. 2015-06-26T09:54:00).': '跟踪日期必须符合EL表达式，如： ${someDate} ,或者一个ISO标准日期，如：2015-06-26T09:54:00',
    'The due date as an EL expression (e.g. ${someDate}) or an ISO date (e.g. 2015-06-26T09:54:00).': '跟踪日期必须符合EL表达式，如： ${someDate} ,或者一个ISO标准日期，如：2015-06-26T09:54:00',
    'Start typing "${}" to create an expression.': '开始键入 "${}" 以创建表达式。',
    'Variables': '变量',
    'Candidate starter': '候选人配置',
    'Task listeners': '任务监听器',
    'Candidate starter groups': '候选开始组',
    'Candidate starter users': '候选开始用户',
    'Tasklist': '任务列表配置',
    'Startable': '启动',
    'Specify more than one group as a comma separated list.': '指定多个组,用逗号分隔',
    'Specify more than one user as a comma separated list.': '指定多个用户,用逗号分隔',
    'This maps to the process definition key.': '这会映射为流程定义的键',
    'CallActivity Type': '调用活动类型',
    'Condition Type': '条件类型',
    'Create UserTask': '创建用户任务',
    'Create CallActivity': '创建调用活动',
    'Called Element': '调用元素',
    'Create DataObjectReference': '创建数据对象引用',
    'Create DataStoreReference': '创建数据存储引用',
    'Multi Instance': '多实例',
    'Loop Cardinality': '实例数量',
    'Element Variable': '元素变量',
    'Completion Condition': '完成条件',
    // 小地图
    'Open minimap': '打开小地图',
    'Close minimap': '关闭小地图',

    // 扩展属性
    'Start: Java class': '关闭小地图'


    // 页面上的英文都可以加对应的键值对...

  };

// 使用 Record<string, any> 类型来定义键值对对象
export const translate = (template: string, replacements: Record<string, any> = {}) => {
  replacements = replacements || {};
  template = translations[template] || template;
  return template.replace(/{([^}]+)}/g, (_, key) => {
    return replacements[key] || '{' + key + '}';
  });
};
````

- 使用汉化：

````typescript
// 添加插件
additionalModules: [
  // 小地图...
  {
    // 汉化
    translate: ['value', translate]
    // 禁用滚轮滚动
    // zoomScroll: ["value", ""],
    // 禁止拖动线
    // bendpoints: ["value", ""],
    // 禁用左侧面板
    // paletteProvider: ["value", ""],
    // 禁止点击节点出现contextPad
    // contextPadProvider: ["value", ""],
    // 禁止双击节点出现label编辑框
    // labelEditingProvider: ["value", ""]
  }
]
````

查看效果：

![translate.png](..%2F..%2F..%2F..%2F..%2F..%2F..%2FDownloads%2Fimages%2Ftranslate.png)

5. 动态加载模型设计文件

之前渲染的是写死的 xml 文件，现在添加接口动态获取：

- 添加后台接口 BpmnJsController：

  `io.github.cmmplb.activiti.controller.BpmnJsController`

    ````java
    package io.github.cmmplb.activiti.controller;
    
    import com.github.xiaoymin.knife4j.annotations.ApiOperationSupport;
    import io.github.cmmplb.activiti.domain.dto.BpmnJsDTO;
    import io.github.cmmplb.activiti.domain.vo.BpmnJsVO;
    import io.github.cmmplb.activiti.result.Result;
    import io.github.cmmplb.activiti.result.ResultUtil;
    import io.github.cmmplb.activiti.service.BpmnJsService;
    import io.swagger.annotations.Api;
    import io.swagger.annotations.ApiOperation;
    import lombok.extern.slf4j.Slf4j;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.web.bind.annotation.*;
    
    /**
     * @author penglibo
     * @date 2023-12-13 16:14:55
     * @since jdk 1.8
     */
    @Api(tags = "bpmn-js 流程设计管理")
    @Slf4j
    @RestController
    @RequestMapping("/bpmn-js")
    public class BpmnJsController {
    
        @Autowired
        private BpmnJsService bpmnJsService;
    
        @ApiOperation("保存流程设计")
        @PutMapping(value = "/save/{id}")
        @ApiOperationSupport(order = 1, ignoreParameters = {"id"})
        public Result<Boolean> saveDesign(@PathVariable(value = "id") String id, @RequestBody BpmnJsDTO dto) {
            dto.setId(id);
            return ResultUtil.success(bpmnJsService.saveDesign(dto));
        }
    
        @ApiOperation("获取模型流程设计")
        @GetMapping(value = "/{id}")
        @ApiOperationSupport(order = 2, ignoreParameters = {"id"})
        public Result<BpmnJsVO> getBpmnInfoById(@PathVariable(value = "id") String id) {
            return ResultUtil.success(bpmnJsService.getBpmnInfoById(id));
        }
    }
    ````

- BpmnJsVO：

  `io.github.cmmplb.activiti.domain.vo.BpmnJsVO`

    ````java
    package io.github.cmmplb.activiti.domain.vo;
    
    import io.swagger.annotations.ApiModel;
    import io.swagger.annotations.ApiModelProperty;
    import lombok.Data;
    
    /**
     * @author penglibo
     * @date 2023-12-14 10:10:39
     * @since jdk 1.8
     */
    
    @Data
    @ApiModel(value = "BpmnJsVO", description = "BpmnJsVO 返回参数")
    public class BpmnJsVO {
    
        @ApiModelProperty(value = "设计页面中使用的字段为 modelId", example = "1")
        private String modelId;
    
        @ApiModelProperty(value = "流程设计 xml")
        private String xml;
    }
    ````

- BpmnJsDTO：

  `io.github.cmmplb.activiti.domain.dto.BpmnJsDTO`

    ````java
    package io.github.cmmplb.activiti.domain.dto;
    
    import io.swagger.annotations.ApiModel;
    import io.swagger.annotations.ApiModelProperty;
    import lombok.Data;
    
    /**
     * @author penglibo
     * @date 2023-10-17 11:13:43
     * @since jdk 1.8
     */
    
    @Data
    @ApiModel(value = "BpmnJsDTO", description = "BpmnJsDTO请求参数")
    public class BpmnJsDTO {
    
        @ApiModelProperty(value = "模型ID", hidden = true)
        private String id;
    
        @ApiModelProperty(value = "流程设计文件 xml")
        private String xml;
    
        @ApiModelProperty(value = "流程设计图片 svg")
        private String svg;
    }
    ````

- BpmnJsService：

  `io.github.cmmplb.activiti.service.BpmnJsService`

    ````java
    package io.github.cmmplb.activiti.service;
    
    import io.github.cmmplb.activiti.domain.dto.BpmnJsDTO;
    import io.github.cmmplb.activiti.domain.vo.BpmnJsVO;
    
    /**
     * @author penglibo
     * @date 2024-10-29 09:22:39
     * @since jdk 1.8
     */
    public interface BpmnJsService {
    
        boolean saveDesign(BpmnJsDTO dto);
    
        BpmnJsVO getBpmnInfoById(String id);
    }
    ````

- BpmnJsServiceImpl：

  `io.github.cmmplb.activiti.service.impl.BpmnJsServiceImpl`

    ````java
    package io.github.cmmplb.activiti.service.impl;
    
    import com.alibaba.fastjson.JSON;
    import com.alibaba.fastjson.JSONObject;
    import io.github.cmmplb.activiti.domain.dto.BpmnJsDTO;
    import io.github.cmmplb.activiti.domain.vo.BpmnJsVO;
    import io.github.cmmplb.activiti.handler.exection.BusinessException;
    import io.github.cmmplb.activiti.service.BpmnJsService;
    import io.github.cmmplb.activiti.service.ModelService;
    import org.activiti.editor.constants.ModelDataJsonConstants;
    import org.activiti.engine.RepositoryService;
    import org.activiti.engine.repository.Model;
    import org.bouncycastle.util.Arrays;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.stereotype.Service;
    
    import java.nio.charset.StandardCharsets;
    
    /**
     * @author penglibo
     * @date 2024-10-29 09:22:47
     * @since jdk 1.8
     */
    
    @Service
    public class BpmnJsServiceImpl implements BpmnJsService {
    
        @Autowired
        private ModelService modelService;
    
        @Autowired
        private RepositoryService repositoryService;
    
        @Override
        public boolean saveDesign(BpmnJsDTO dto) {
            Model model = repositoryService.getModel(dto.getId());
            if (null == model) {
                throw new RuntimeException("模型信息不存在");
            }
            // 版本号, 这里直接在代码里加 1 了, 应该在数据库利用行锁 version = version + 1 的方式来修改, 或者加锁, 防止数据重复更新
            int revision = model.getVersion() + 1;
            JSONObject metaInfo = JSON.parseObject(model.getMetaInfo());
            // 版本号从模型信息中获取, 因为设计页面上的版本号是字符串, 而模型信息的版本号是 int, 防止转换异常
            metaInfo.put(ModelDataJsonConstants.MODEL_REVISION, revision);
            model.setMetaInfo(metaInfo.toString());
            model.setVersion(revision);
            // 更新模型信息
            repositoryService.saveModel(model);
    
            // 更新流程设计文件, 注意, activiti-modeler 保存的是 json, bpmn-js 保存的是 xml
            repositoryService.addModelEditorSource(dto.getId(), dto.getXml().getBytes(StandardCharsets.UTF_8));
    
            // 更新流程图片信息
            modelService.saveSvg(dto.getId(), dto.getSvg());
            return true;
        }
    
        @Override
        public BpmnJsVO getBpmnInfoById(String id) {
            Model model = repositoryService.getModel(id);
            if (null == model) {
                throw new BusinessException("模型信息不存在");
            }
            byte[] modelData = repositoryService.getModelEditorSource(id);
            BpmnJsVO vo = new BpmnJsVO();
            vo.setModelId(model.getId());
            if (!Arrays.isNullOrEmpty(modelData)) {
                vo.setXml(new String(modelData, StandardCharsets.UTF_8));
            }
            return vo;
        }
    }
    ````

- 之后是前端 api 和 ts 类型声明

  `spring-boot-activiti/web/src/api/process/bpmnJs.ts`

    ````typescript
    import request from '@/utils/http/axios';
    import {Result} from '@/utils/http/axios/axios';
    
    /**
     * 获取模型流程设计
     */
    export const getBpmnInfoById = (id: string) => {
      return request.get<Result<BpmnJsVO>>({
        url: '/bpmn-js/' + id
      });
    };
    
    /**
     * 保存流程设计
     */
    export const save = (id: string, data: BpmnJsDTO) => {
      return request.put<Result<boolean>>({
        url: '/bpmn-js/save/' + id,
        data
      });
    };
    ````

  `spring-boot-activiti/web/src/api/process/types/bpmnJs.d.ts`

    ````typescript
    // declare关键字用于告诉编译器某个标识符已经存在，但不需要进行类型检查
    declare interface BpmnJsVO {
      id: string;
      name: string;
      xml: object;
    }
    
    declare interface BpmnJsDTO {
      xml: object;
      svg: string;
    }
    ````

- 添加一个按钮，点击跳转：

`spring-boot-activiti/web/src/views/process/model/index.vue`

````

<el-button
    v-if="scope.row.designType === 2"
    icon="Document"
    @click="handlerDesignBpmnJs(scope.row)"
    text
    style="color: rgb(62,0,128)"
>设计(bpmn-js)
</el-button
>

// 点击设计(bpmn-js)按钮
const handlerDesignBpmnJs = (row: ModelVO) => {
// 跳转到模型设计页面
window.open('/bpmn-js?modelId=' + row.id, '_blank');
};
````

- 预览的代码改成从接口获取：

  `spring-boot-activiti/web/src/views/process/model/bpmn-js.vue`

    ````
    const router = useRouter();
    
    // 预览
    const preview = async () => {
      // 先写死一个 xml 来渲染测试, 这个 xml 是之前用 idea 插件画的 resources/processes/test.bpmn20.xml
      // const xmlString = `<?xml version="1.0" encoding="UTF-8"?><definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:activiti="http://activiti.org/bpmn" targetNamespace="http://www.activiti.org/processdef"><process id="test" name="test" isExecutable="true"><startEvent id="sid-e8a69d3a-e0fe-4728-b1aa-cc6e967ad749" /><userTask id="sid-9002d505-244f-420a-bd96-39f96f40c49a" name="提交申请" /><userTask id="sid-cb3c722b-808f-4932-98ca-aab433c4da25" name="领导审批" /><endEvent id="sid-1918ce19-1394-40d8-b0a6-a661e89ef42d" /><sequenceFlow id="sid-1104d862-1837-474b-bc68-77ae330abca9" sourceRef="sid-e8a69d3a-e0fe-4728-b1aa-cc6e967ad749" targetRef="sid-9002d505-244f-420a-bd96-39f96f40c49a" /><sequenceFlow id="sid-5ddc1d3b-f32b-4eb8-99bd-3fb170ad495f" sourceRef="sid-9002d505-244f-420a-bd96-39f96f40c49a" targetRef="sid-cb3c722b-808f-4932-98ca-aab433c4da25" /><sequenceFlow id="sid-bb10ac4b-83ec-48df-9dd4-2b5edc7f5507" sourceRef="sid-cb3c722b-808f-4932-98ca-aab433c4da25" targetRef="sid-1918ce19-1394-40d8-b0a6-a661e89ef42d" /></process><bpmndi:BPMNDiagram id="BPMNDiagram_test"><bpmndi:BPMNPlane id="BPMNPlane_test" bpmnElement="test"><bpmndi:BPMNShape id="shape-31f6eace-2180-4508-8c59-8134d4ba2305" bpmnElement="sid-9002d505-244f-420a-bd96-39f96f40c49a"><omgdc:Bounds x="880" y="357" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="shape-19af1961-8fd8-45bf-a7ff-f0c5078d9277" bpmnElement="sid-cb3c722b-808f-4932-98ca-aab433c4da25"><omgdc:Bounds x="1080" y="357" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="shape-dde69d06-7654-4b35-b2c3-ffbb12f2a5a8" bpmnElement="sid-1918ce19-1394-40d8-b0a6-a661e89ef42d"><omgdc:Bounds x="1280" y="382" width="30" height="30" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="shape-6b082d8d-d467-4359-8834-114f9362d628" bpmnElement="sid-e8a69d3a-e0fe-4728-b1aa-cc6e967ad749"><omgdc:Bounds x="725" y="382" width="30" height="30" /></bpmndi:BPMNShape><bpmndi:BPMNEdge id="edge-f1ae40a2-95e4-4006-b001-83376f57baa9" bpmnElement="sid-1104d862-1837-474b-bc68-77ae330abca9"><omgdi:waypoint x="755" y="397" /><omgdi:waypoint x="880" y="397" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="edge-67f619bc-02a6-4323-8eb8-60df8ee1497a" bpmnElement="sid-5ddc1d3b-f32b-4eb8-99bd-3fb170ad495f"><omgdi:waypoint x="980" y="397" /><omgdi:waypoint x="1080" y="397" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="edge-ba818e30-4fff-42b6-8520-a52fc90ec7c5" bpmnElement="sid-bb10ac4b-83ec-48df-9dd4-2b5edc7f5507"><omgdi:waypoint x="1180" y="397" /><omgdi:waypoint x="1280" y="397" /></bpmndi:BPMNEdge></bpmndi:BPMNPlane></bpmndi:BPMNDiagram></definitions>`;
      // 从路由参数中获取 modelId
      const modelId = router.currentRoute.value.query.modelId;
      if (modelId) {
        const res = await getBpmnInfoById(String(modelId));
        if (res.code === 200 && res.data) {
          // 渲染流程图
          try {
            await bpmnModeler.value.importXML(res.data.xml);
          } catch (e) {
            ElMessage({
              message: '渲染流程失败, 可能是 activiti-modeler 设计的流程 xml 和 bpmn-js 节点不对应',
              type: 'error'
            });
            // 渲染流程失败的话, 创建一个有开始节点的画板
            await bpmnModeler.value.createDiagram();
          }
        } else {
          ElMessage({message: res.msg, type: 'error'});
        }
      }
    };
    ````

- 保存模型设计：

  `spring-boot-activiti/web/src/views/process/model/bpmn-js.vue`

    ````typescript
    // 保存按钮事件
    const handlerSave = async (close?: boolean) => {
      const modelId = router.currentRoute.value.query.modelId;
      if (modelId) {
        // 可以点保存查看下控制台 xml
        const {xml} = await bpmnModeler.value.saveXML();
        const {svg} = await bpmnModeler.value.saveSVG();
        const res = await save(String(modelId), {xml, svg});
        if (res.code === 200 && res.data) {
          ElMessage({message: res.msg, type: 'success'});
          if (close) {
            // 1 秒后关闭当前窗口
            setTimeout(() => {
              window.close();
            }, 1000);
          }
        } else {
          ElMessage({message: res.msg, type: 'error'});
        }
      }
    };
    ````

### 其他

1. 同时整合 activiti modeler 和 bpmn-js 的话, activiti modeler 模型的属性信息会丢失, 因为 bpmn-js 的 xml 文件信息中没有
   properties 属性, 也就是说在 activiti modeler 设计的流程, 填写的作者相关属性, 在 bpmn-js 中就会清空了，所以在这里模型
   metaInfo 中多存储一个模型设计类型字段, designType:1-activiti-modeler;2-bpmn-js; 通过判断 designType 来定义模型信息

2. 修改一下标题：

`spring-boot-activiti/web/index.html`

````html

<head>
  <meta charset="UTF-8"/>
  <!-- 可以百度在线制作一个小图标, 放到 public 文件夹下 -->
  <link rel="icon" type="image/svg+xml" href="/favicon.ico"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- 修改标题 -->
  <title>Spring Boot Activiti</title>
</head>
````

### bug

- 这个 css 有个属性，同级 hover 应该是 &:hover，写成了 &.hover

  `/spring-boot-activiti/web/src/layout/components/navbar.vue`

    ````css
        &:hover {
          // 鼠标指针变成手势
          cursor: pointer;
        }
    ````