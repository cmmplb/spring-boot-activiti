# 流程定义管理

流程定义查看流程图时，需要使用到 activiti-image-generator 依赖：

````xml
<!-- 流程图预览 -->
<dependency>
    <groupId>org.activiti</groupId>
    <artifactId>activiti-image-generator</artifactId>
    <version>${activiti-spring-boot-starter.version}</version>
    <exclusions>
        <exclusion>
            <groupId>org.apache.xmlgraphics</groupId>
            <artifactId>batik-awt-util</artifactId>
        </exclusion>
        <exclusion>
            <groupId>org.apache.xmlgraphics</groupId>
            <artifactId>batik-dom</artifactId>
        </exclusion>
        <exclusion>
            <groupId>org.apache.xmlgraphics</groupId>
            <artifactId>batik-svggen</artifactId>
        </exclusion>
    </exclusions>
</dependency>
````

## 后端

- 由于都是些动态维护，这里直接写完代码，需要注意的地方在代码里面都描述了

- SuspendDefinitionDTO

`io.github.cmmplb.activiti.domain.dto.SuspendDefinitionDTO`

````java
package io.github.cmmplb.activiti.domain.dto;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

/**
 * @author penglibo
 * @date 2024-11-02 18:58:58
 * @since jdk 1.8
 */

@Data
@ApiModel(value = "SuspendProcessDefinitionDTO", description = "流程设计请求参数")
public class SuspendDefinitionDTO {

    @ApiModelProperty(value = "主键", example = "1")
    private String id;

    @ApiModelProperty(value = "是否挂起/激活关联的实例", example = "true")
    private Boolean activateProcessInstances;

    @ApiModelProperty(value = "定时挂起/激活时间", example = "2023-11-11 12:12:11")
    private String activationDate;
}
````

- `ProcessDefinitionVO`

`io.github.cmmplb.activiti.domain.vo.ProcessDefinitionVO`

````java
package io.github.cmmplb.activiti.domain.vo;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

/**
 * @author penglibo
 * @date 2024-11-02 18:57:08
 * @since jdk 1.8
 */

@Data
@ApiModel(value = "ProcessDefinitionVO", description = "流程定义返回参数")
public class ProcessDefinitionVO {

    @ApiModelProperty(value = "主键", example = "1")
    private String id;

    @ApiModelProperty(value = "类型", example = "home")
    private String category;

    @ApiModelProperty(value = "名称", example = "请假")
    private String name;

    @ApiModelProperty(value = "关键字", example = "leave")
    private String key;

    @ApiModelProperty(value = "描述信息", example = "请假")
    private String description;

    @ApiModelProperty(value = "版本，从1开始", example = "1")
    private Integer version;

    @ApiModelProperty(value = "资源路径", example = "/usr/local/leave.bpmn20.xml")
    private String resourceName;

    @ApiModelProperty(value = "部署ID", example = "1")
    private String deploymentId;

    @ApiModelProperty(value = "图片资源文件名称, png 流程图片名称", example = "请假申请.png")
    private String diagramResourceName;

    @ApiModelProperty(value = "是否挂起/激活", example = "true")
    private Boolean suspended;

    @ApiModelProperty(value = "自定义应用版本号, 需要设置 ProjectManifest", example = "true")
    private Integer appVersion;
}
````

- ProcessDefinitionConvert

`io.github.cmmplb.activiti.convert.ProcessDefinitionConvert`

````java
package io.github.cmmplb.activiti.convert;

import io.github.cmmplb.activiti.domain.vo.ProcessDefinitionVO;
import org.activiti.engine.repository.ProcessDefinition;
import org.mapstruct.Mapper;

/**
 * @author penglibo
 * @date 2022-08-03 16:56:25
 * @since jdk 1.8
 */

@Mapper
public interface ProcessDefinitionConvert extends Converter<ProcessDefinition, ProcessDefinitionVO> {

}
````

- ProcessDefinitionController

`io.github.cmmplb.activiti.controller.ProcessDefinitionController`

````java
package io.github.cmmplb.activiti.controller;

import com.github.xiaoymin.knife4j.annotations.ApiOperationSupport;
import com.github.xiaoymin.knife4j.annotations.ApiSupport;
import io.github.cmmplb.activiti.beans.PageResult;
import io.github.cmmplb.activiti.beans.QueryPageBean;
import io.github.cmmplb.activiti.domain.dto.SuspendDefinitionDTO;
import io.github.cmmplb.activiti.domain.vo.ProcessDefinitionVO;
import io.github.cmmplb.activiti.result.Result;
import io.github.cmmplb.activiti.result.ResultUtil;
import io.github.cmmplb.activiti.service.ProcessDefinitionService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * @author penglibo
 * @date 2024-11-02 18:49:28
 * @since jdk 1.8
 */

@Api(tags = "定义管理")
@Slf4j
@RestController
@ApiSupport(order = 5)
@RequestMapping("/process/definition")
public class ProcessDefinitionController {

    @Autowired
    private ProcessDefinitionService processDefinitionService;

    @ApiOperation("分页条件查询列表")
    @PostMapping(value = "/paged")
    @ApiOperationSupport(order = 1)
    public Result<PageResult<ProcessDefinitionVO>> getByPaged(@RequestBody QueryPageBean queryPageBean) {
        return ResultUtil.success(processDefinitionService.getByPaged(queryPageBean));
    }

    @ApiOperation("查看流程文件")
    @GetMapping(value = "/show/{deploymentId}")
    @ApiOperationSupport(order = 2, ignoreParameters = {"deploymentId"})
    public Result<String> show(@PathVariable(value = "deploymentId") String deploymentId, @RequestParam(value = "resourceName") String resourceName) {
        // 注意这里的 resource 不能使用 PathVariable, 不然 resource 值为 /processes/xxx.bpmn20.xml 的时候，会报路径不存在,
        // resources/processes 路径下的流程文件设置了自动部署, 其生成的 resource 名字为 /processes/xxx.bpmn20.xml
        return ResultUtil.success(processDefinitionService.show(deploymentId, resourceName));
    }

    @ApiOperation("查看流程图")
    @GetMapping(value = "/show/chart/{id}")
    @ApiOperationSupport(order = 3, ignoreParameters = {"id", "designType"})
    public void showChart(@PathVariable(value = "id") String id) {
        processDefinitionService.showChart(id);
    }

    @ApiOperation("查看流程图-bpmn-js")
    @GetMapping(value = "/show/chart/bpmn-js/{id}")
    @ApiOperationSupport(order = 4, ignoreParameters = {"id"})
    public Result<String> showChartBpmnJs(@PathVariable(value = "id") String id) {
        return ResultUtil.success(processDefinitionService.showChartBpmnJs(id));
    }

    @ApiOperation("将流程定义转为模型")
    @PostMapping(value = "/exchange/{id}/{designType}")
    @ApiOperationSupport(order = 5, ignoreParameters = {"id", "designType"})
    public Result<Boolean> exchangeToModel(@PathVariable(value = "id") String id, @PathVariable(value = "designType") Integer designType) {
        return ResultUtil.success(processDefinitionService.exchangeToModel(id, designType));
    }

    @ApiOperation("挂起流程定义")
    @PostMapping(value = "/suspend/{id}")
    @ApiOperationSupport(order = 6, ignoreParameters = {"id"})
    public Result<Boolean> suspend(@PathVariable(value = "id") String id, @RequestBody SuspendDefinitionDTO dto) {
        dto.setId(id);
        return ResultUtil.success(processDefinitionService.suspend(dto));
    }

    @ApiOperation("激活流程定义")
    @PostMapping(value = "/activate/{id}")
    @ApiOperationSupport(order = 7, ignoreParameters = {"id"})
    public Result<Boolean> activate(@PathVariable(value = "id") String id, @RequestBody SuspendDefinitionDTO dto) {
        dto.setId(id);
        return ResultUtil.success(processDefinitionService.activate(dto));
    }
}
````

- ProcessDefinitionService

`io.github.cmmplb.activiti.service.ProcessDefinitionService`

````java
package io.github.cmmplb.activiti.service;

import io.github.cmmplb.activiti.beans.PageResult;
import io.github.cmmplb.activiti.beans.QueryPageBean;
import io.github.cmmplb.activiti.domain.dto.SuspendDefinitionDTO;
import io.github.cmmplb.activiti.domain.vo.ProcessDefinitionVO;

/**
 * @author penglibo
 * @date 2024-11-02 18:57:48
 * @since jdk 1.8
 */

public interface ProcessDefinitionService {

    PageResult<ProcessDefinitionVO> getByPaged(QueryPageBean queryPageBean);

    String show(String deploymentId, String resourceName);

    void showChart(String id);

    String showChartBpmnJs(String id);

    boolean exchangeToModel(String id, Integer designType);

    boolean suspend(SuspendDefinitionDTO dto);

    boolean activate(SuspendDefinitionDTO dto);
}
````

- ProcessDefinitionServiceImpl

`io.github.cmmplb.activiti.service.impl.ProcessDefinitionServiceImpl`

````java
package io.github.cmmplb.activiti.service.impl;

import com.fasterxml.jackson.databind.node.ObjectNode;
import io.github.cmmplb.activiti.beans.PageResult;
import io.github.cmmplb.activiti.beans.QueryPageBean;
import io.github.cmmplb.activiti.convert.ProcessDefinitionConvert;
import io.github.cmmplb.activiti.domain.dto.ModelDTO;
import io.github.cmmplb.activiti.domain.dto.SuspendDefinitionDTO;
import io.github.cmmplb.activiti.domain.vo.ProcessDefinitionVO;
import io.github.cmmplb.activiti.handler.exection.BusinessException;
import io.github.cmmplb.activiti.service.ModelService;
import io.github.cmmplb.activiti.service.ProcessDefinitionService;
import io.github.cmmplb.activiti.utils.*;
import lombok.extern.slf4j.Slf4j;
import org.activiti.bpmn.converter.BpmnXMLConverter;
import org.activiti.bpmn.model.BpmnModel;
import org.activiti.editor.language.json.converter.BpmnJsonConverter;
import org.activiti.engine.RepositoryService;
import org.activiti.engine.repository.ProcessDefinition;
import org.activiti.engine.repository.ProcessDefinitionQuery;
import org.activiti.image.ProcessDiagramGenerator;
import org.activiti.image.impl.DefaultProcessDiagramGenerator;
import org.apache.batik.transcoder.TranscoderInput;
import org.apache.batik.transcoder.TranscoderOutput;
import org.apache.batik.transcoder.image.PNGTranscoder;
import org.apache.commons.io.IOUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.io.InputStream;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.stream.Collectors;

/**
 * @author penglibo
 * @date 2024-11-02 18:57:56
 * @since jdk 1.8
 */

@Slf4j
@Service
public class ProcessDefinitionServiceImpl implements ProcessDefinitionService {

    // 管理和控制流程定义的服务接口，包括部署、查询和删除流程定义等功能；
    @Autowired
    private RepositoryService repositoryService;

    @Autowired
    private ModelService modelService;

    @Override
    public PageResult<ProcessDefinitionVO> getByPaged(QueryPageBean queryPageBean) {
        ProcessDefinitionQuery query = repositoryService.createProcessDefinitionQuery();
        // 根据模型名称模糊查询
        if (StringUtils.isNotBlank(queryPageBean.getKeywords())) {
            query.processDefinitionNameLike(queryPageBean.getKeywords());
        }
        List<ProcessDefinitionVO> res = new ArrayList<>();
        // count 查询总数
        long total = query.count();
        if (total > 0) {
            List<ProcessDefinition> list = query.listPage(queryPageBean.getStart(), queryPageBean.getSize());
            // .stream().map() jdk 8 语法
            return new PageResult<>(total, list.stream().map(processDefinition -> {
                        ProcessDefinitionVO vo = ConverterUtil.convert(ProcessDefinitionConvert.class, processDefinition);
                        vo.setSuspended(processDefinition.isSuspended());
                        return vo;
                    }
            ).collect(Collectors.toList()));
        }
        return new PageResult<>(total, res);
    }

    @Override
    public String show(String deploymentId, String resourceName) {
        InputStream is = repositoryService.getResourceAsStream(deploymentId, resourceName);
        byte[] xmlBytes;
        try {
            xmlBytes = IOUtils.toByteArray(is);
        } catch (IOException e) {
            throw new BusinessException("解析部署流程文件失败");
        }
        try {
            return XmlUtil.formatXml(new String(xmlBytes, StandardCharsets.UTF_8));
        } catch (Exception e) {
            log.info("格式化 xml 失败");
        }
        // 格式化失败的话返回原始数据
        return new String(xmlBytes, StandardCharsets.UTF_8);
    }

    @Override
    public void showChart(String id) {
        BpmnModel bpmnModel = repositoryService.getBpmnModel(id);
        if (null == bpmnModel) {
            throw new BusinessException("流程文件信息不存在");
        }
        // ========activiti 7 移除了 processEngineConfiguration.getProcessDiagramGenerator() 的方法========
        // ProcessEngine defaultProcessEngine = ProcessEngines.getDefaultProcessEngine();
        // ProcessEngineConfigurationImpl processEngineConfiguration = (ProcessEngineConfigurationImpl) defaultProcessEngine.getProcessEngineConfiguration();
        // ProcessDiagramGenerator processDiagramGenerator = processEngineConfiguration.getProcessDiagramGenerator();
        // processDiagramGenerator.generateDiagram(bpmnModel, "宋体", "宋体", "宋体");

        // ========改为了直接 new 该接口的实例========
        ProcessDiagramGenerator diagramGenerator = new DefaultProcessDiagramGenerator();
        // 但是用这个会报错 nested exception is java.lang.NoClassDefFoundError: org/apache/batik/util/XMLConstants
        // batik-util:1.9 的版本移除了 XMLConstants, 迁移到 batik-constants 包里面了
        // 查看 jar 依赖版本发现这个类 org.apache.batik.dom.util.DOMUtilities 包的版本是 batik-dom:1.10, 应该是和哪个依赖冲突了
        // 找了一下在 org.activiti:activiti-image-generator 这个依赖里面发现依赖冲突, pom 里面排除一下
        InputStream is = diagramGenerator.generateDiagram(bpmnModel, "宋体", "宋体", "宋体");
        // =======================================

        HttpServletResponse response = ServletUtil.getResponse();
        try {
            // 生成的图表默认是 svg 格式的
            // response.setContentType("image/svg+xml");
            // IOUtils.copy(is, response.getOutputStream());

            // 转换 svg 为 png 响应
            response.setContentType("image/png");
            new PNGTranscoder().transcode(new TranscoderInput(is), new TranscoderOutput(response.getOutputStream()));

        } catch (Exception e) {
            throw new BusinessException("流程文件转换为图形失败");
        }
    }

    @Override
    public String showChartBpmnJs(String id) {
        BpmnModel bpmnModel = repositoryService.getBpmnModel(id);
        if (null == bpmnModel) {
            throw new BusinessException("流程文件信息不存在");
        }
        // bpmn-js 通过 xml 来生成流程图
        byte[] xmlBytes = (new BpmnXMLConverter()).convertToXML(bpmnModel, StandardCharsets.UTF_8.name());
        return new String(xmlBytes, StandardCharsets.UTF_8);
    }

    @Override
    public boolean exchangeToModel(String id, Integer designType) {
        // 根据 id 获取流程定义信息
        ProcessDefinition definition = repositoryService.createProcessDefinitionQuery().processDefinitionId(id).singleResult();
        if (null == definition) {
            throw new BusinessException("流程定义信息不存在");
        }
        // 这里看需求, 转换的模型存在是否更新版本替换, 我这里是调用新增模型了, 不允许重复, 如果要更新替换要补充一下逻辑
        ModelDTO dto = new ModelDTO();
        dto.setKey(definition.getKey());
        dto.setName(definition.getName());
        dto.setAuthor(SecurityUtil.getUserName());
        dto.setCategory(definition.getCategory());
        dto.setDescription(definition.getDescription());
        dto.setDesignType(designType);
        dto.setGenerateProcess(false);
        // 保存模型信息
        modelService.save(dto);

        // 根据 id 获取流程定义的 bpmn 文件
        BpmnModel bpmnModel = repositoryService.getBpmnModel(id);
        // 添加流程设计文件, 注意, activiti-modeler 保存的是 json, bpmn-js 保存的是 xml
        byte[] modelData;
        if (designType == 1) {
            // 使用 BpmnJsonConverter 把 bpmnModel 转换为 jsonNode
            ObjectNode objectNode = new BpmnJsonConverter().convertToJson(bpmnModel);
            modelData = objectNode.toString().getBytes(StandardCharsets.UTF_8);
        } else {
            // 使用 BpmnXMLConverter 把 bpmnModel 转换为 xml
            modelData = new BpmnXMLConverter().convertToXML(bpmnModel);
        }
        repositoryService.addModelEditorSource(dto.getId(), modelData);
        return true;
    }

    @Override
    public boolean suspend(SuspendDefinitionDTO dto) {
        return activate(false, dto);
    }

    @Override
    public boolean activate(SuspendDefinitionDTO dto) {
        return activate(true, dto);
    }

    public boolean activate(boolean isActivate, SuspendDefinitionDTO dto) {
        Date date = null;
        if (StringUtils.isNotEmpty(dto.getActivationDate())) {
            date = DateUtil.parseToDate(dto.getActivationDate(), DateUtil.FORMAT_DATE_YYYY_MM_DD_HH_MM_SS);
        }
        try {
            if (isActivate) {
                // 激活, 并且激活关联的实例
                repositoryService.activateProcessDefinitionById(dto.getId(), dto.getActivateProcessInstances(), date);
            } else {
                // 挂起
                repositoryService.suspendProcessDefinitionById(dto.getId(), dto.getActivateProcessInstances(), date);
            }
        } catch (Exception e) {
            log.error("激活流程失败", e);
            throw new BusinessException(isActivate ? "激活流程失败" : "挂起流程失败");
        }
        return true;
    }
}
````

- 转换流程定义为模型时，由于模型之前写过新增，这里就直接使用了，但是得改造一下之前的新增代码，因为模型新增时没有流程文件单独构建空的流程，这里转换显然是有流程文件的，在新增模型参数加个是否生成流程文件判断

`io.github.cmmplb.activiti.domain.dto.ModelDTO`

````java
public class ModelDTO {
    // ...
    @ApiModelProperty(value = "是否生成流程文件", hidden = true)
    private Boolean generateProcess;

    public Boolean getGenerateProcess() {
        return null == generateProcess || generateProcess;
    }
````

- 之前保存 bpmn-js 流程设计时，没有取模型中的属性，这里添加工具类，处理：

    1. 添加模型时把模型相关数据初始化到模型文件 xml

    2. 保存模型设计时，把 xml 中的属性提取出来更新到模型信息

`io.github.cmmplb.activiti.utils.XmlUtil`

````java
package io.github.cmmplb.activiti.utils;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.NodeList;
import org.xml.sax.InputSource;
import org.xml.sax.SAXException;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.OutputKeys;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerException;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;
import java.io.*;
import java.util.Map;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * @author penglibo
 * @date 2024-10-31 15:46:34
 * @since jdk 1.8
 */

@Slf4j
public class XmlUtil {

    private static final Pattern VARIABLE_PATTERN = Pattern.compile("\\$\\{(.*?)}");

    /**
     * 格式化输出 xml
     * @param xmlString xml 字符串
     * @return 格式化后的 xml 字符串
     */
    public static String formatXml(String xmlString) throws Exception {
        DocumentBuilderFactory documentBuilderFactory = DocumentBuilderFactory.newInstance();
        documentBuilderFactory.setCoalescing(true);
        StringWriter stringWriter = new StringWriter();
        TransformerFactory transformerFactory = TransformerFactory.newInstance();
        Transformer transformer = transformerFactory.newTransformer();
        transformer.setOutputProperty(OutputKeys.INDENT, "yes");
        transformer.setOutputProperty("{http://xml.apache.org/xslt}indent-amount", "2");
        transformer.setOutputProperty(OutputKeys.OMIT_XML_DECLARATION, "yes");
        transformer.transform(new DOMSource(documentBuilderFactory.newDocumentBuilder().parse(new InputSource(new StringReader(xmlString)))), new StreamResult(stringWriter));
        return stringWriter.toString();
    }

    /**
     * 提取字符串中${}包裹的变量，并根据提供的变量值映射进行替换
     * @param template  包含变量的模板字符串，如 "Hello, ${name}! Today is ${day}."
     * @param variables 变量值映射，如 {"name": "John", "day": "Monday"}
     * @return 替换后的字符串
     */
    public static String replaceXml(String template, Map<String, Object> variables) {
        Matcher matcher = VARIABLE_PATTERN.matcher(template);
        StringBuffer result = new StringBuffer();
        while (matcher.find()) {
            String variableName = matcher.group(1);
            matcher.appendReplacement(result, variables.getOrDefault(variableName, "").toString());
        }
        matcher.appendTail(result);
        return result.toString();
    }

    /**
     * 获取指定 XML 标签的内容
     * @param xmlString
     * @param elementName
     * @return
     */
    public static String getElementContent(String xmlString, String elementName) {
        // 构建查找指定XML标签的正则表达式
        String regex = "<" + elementName + ">(.*?)</" + elementName + ">";
        Pattern pattern = Pattern.compile(regex);
        Matcher matcher = pattern.matcher(xmlString);
        String result = "";
        while (matcher.find()) {
            result = matcher.group(1);
        }
        return result;
    }

    /**
     * 使用正则表达式查找指定XML标签并替换其内容
     * · @param xmlContent 原始XML内容
     * @param elementName 要查找的XML标签名
     * @param content 要替换成的内容
     * @return 替换后的XML内容
     */
    public static String setElementContent(String xmlString, String elementName, String content) {
        // 构建查找指定XML标签的正则表达式
        String regex = "<" + elementName + ">(.*?)</" + elementName + ">";
        Pattern pattern = Pattern.compile(regex);
        Matcher matcher = pattern.matcher(xmlString);
        // 进行替换操作
        StringBuffer result = new StringBuffer();
        while (matcher.find()) {
            matcher.appendReplacement(result, "<" + elementName + ">" + content + "</" + elementName + ">");
        }
        matcher.appendTail(result);
        return result.toString();
    }

    // 获取 xml 中某个元素的属性内容
    public static String getElementAttribute(String xmlString, String elementName, String attributeName) {
        ElementDTO dto = getElement(xmlString, elementName);
        if (dto == null) {
            return null;
        }
        Element element = dto.getElement();
        // 查找属性
        if (element.hasAttribute(attributeName)) {
            return element.getAttribute(attributeName);
        }
        return null;
    }

    /**
     * 替换xml中某个元素中的属性配置
     * @param xmlString      原始 xml
     * @param elementName    标签名称
     * @param attributeName  属性名称
     * @param attributeValue 替换的属性值
     * @return 替换后的 xml
     */
    public static String setElementAttribute(String xmlString, String elementName, String attributeName, String attributeValue) {
        ElementDTO dto = getElement(xmlString, elementName);
        if (dto == null) {
            // 没有找到返回原 xml
            return xmlString;
        }
        Element element = dto.getElement();
        // 替换属性
        if (element.hasAttribute(attributeName)) {
            element.setAttribute(attributeName, attributeValue);
        } else {
            log.error("未找到标签:{}", elementName);
            return xmlString;
        }
        try {
            // 将修改后的 DOM 对象转换为 XML 字符串
            StringWriter stringWriter = new StringWriter();
            TransformerFactory transformerFactory = TransformerFactory.newInstance();
            Transformer transformer = transformerFactory.newTransformer();
            transformer.transform(new DOMSource(dto.getDocument()), new StreamResult(stringWriter));
            return stringWriter.toString();
        } catch (TransformerException e) {
            log.error("dom 转换 xml 失败", e);
        }
        return xmlString;
    }

    private static ElementDTO getElement(String xmlString, String elementName) {
        try {
            // 创建一个 DocumentBuilderFactory 实例
            DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
            // 使用 DocumentBuilderFactory 创建 DocumentBuilder 对象
            DocumentBuilder builder = factory.newDocumentBuilder();
            // 将 XML 字符串转换为输入流
            InputStream inputStream = new ByteArrayInputStream(xmlString.getBytes());
            // 使用 DocumentBuilder 对象解析 XML 输入流并获取 Document 对象
            Document document = builder.parse(inputStream);
            // 获取根元素
            Element rootElement = document.getDocumentElement();
            // 查找需要替换属性的元素
            NodeList nodeList = rootElement.getElementsByTagName(elementName);
            if (nodeList.getLength() > 0) {
                return new ElementDTO((Element) nodeList.item(0), document);
            } else {
                return null;
            }
        } catch (ParserConfigurationException | SAXException | IOException e) {
            log.error("未找到标签:{}", elementName);
            return null;
        }
    }

    @Data
    @AllArgsConstructor
    @NoArgsConstructor
    public static class ElementDTO {
        private Element element;
        private Document document;

        public ElementDTO(Element element) {
            this.element = element;
        }
    }

}
````

- 补充模型保存和更新模型的逻辑，主要是 save() 和 update()

`io.github.cmmplb.activiti.service.impl.ModelServiceImpl`

````java

@Slf4j
@Service
public class ModelServiceImpl implements ModelService {

    @Override
    public boolean save(ModelDTO dto) {
        // 校验模型关键字是否重复
        ModelQuery modelQuery = repositoryService.createModelQuery();
        List<Model> list = modelQuery.modelKey(dto.getKey()).list();
        if (!CollectionUtils.isEmpty(list)) {
            throw new BusinessException("模型标识不能重复");
        }
        // 初始化一个空模型, 这个 Model 实体对应 ACT_RE_MODEL 表
        Model model = repositoryService.newModel();
        // 模型名称
        model.setName(dto.getName());
        // 模型关键字
        model.setKey(dto.getKey());
        // 模型类型, 自定义
        model.setCategory(dto.getCategory());
        // 版本号, 默认为 1, 启动流程时如果是 startProcessInstanceByKey 启动的, 则会用最新版本的流程定义执行流程.
        int revision = 1;
        model.setVersion(revision);
        Map<String, Object> metaInfo = new HashMap<>();
        metaInfo.put(ModelDataJsonConstants.MODEL_NAME, dto.getName());
        metaInfo.put(ModelDataJsonConstants.MODEL_REVISION, revision);
        metaInfo.put(ModelDataJsonConstants.MODEL_DESCRIPTION, dto.getDescription());
        // 添加一个模型设计类型字段
        metaInfo.put(ModelDTO.DESIGN_TYPE, dto.getDesignType());
        // json 格式存储流程定义信息
        model.setMetaInfo(JSON.toJSONString(metaInfo));
        // 保存模型到 act_re_model 表
        repositoryService.saveModel(model);
        // 这个一定要设置一下, 用来转换模型时, 保存关联模型使用的
        dto.setId(model.getId());

        // 构建一个空模型文件 ModelEditorSource, 这个步骤是为了后续设计流程图时使用, 如果没有的话, activiti modeler 页面空白操作不了
        // 设计类型:1-activiti modeler;2-bpmn-js; bpmn-js 没有 properties 属性
        if (dto.getDesignType().equals(1)) {
            JSONObject bpmnXml = new JSONObject();
            // 为什么是 canvas 这个值? 可以去设计一个流程之后, 查看 getModelEditorSource 返回的 json 数据, 等后面写了流程设计之后查看
            bpmnXml.put(EditorJsonConstants.EDITOR_SHAPE_ID, "canvas");

            // 创建 activiti modeler 空节点
            HashMap<String, String> stencilset = new HashMap<>();
            stencilset.put("namespace", "http://b3mn.org/stencilset/bpmn2.0#");
            bpmnXml.put("stencilset", stencilset);

            // 更新 activiti-modeler 流程设计文件
            saveJsonXml(bpmnXml, model.getId(), dto.getName(), dto.getDescription(), dto.getAuthor(), revision);
        } else {
            // 更新 bpmn-js 流程设计文件
            saveBpmnJsXml(null, model.getId(), dto.getKey(), dto.getName(), dto.getDescription(), revision);
        }
        return true;
    }

    @Override
    public boolean update(ModelDTO dto) {
        Model model = repositoryService.getModel(dto.getId());
        if (null == model) {
            throw new BusinessException("模型信息不存在");
        }
        // 校验模型关键字是否重复
        ModelQuery modelQuery = repositoryService.createModelQuery();
        List<Model> list = modelQuery.modelKey(dto.getKey()).list();
        if (!CollectionUtils.isEmpty(list) && !list.get(0).getId().equals(dto.getId())) {
            throw new BusinessException("模型标识不能重复");
        }
        // 模型名称
        model.setName(dto.getName());
        // 模型关键字
        model.setKey(dto.getKey());
        // 模型类型
        model.setCategory(dto.getCategory());
        // 版本号, 这里直接在代码里加 1 了, 应该在数据库利用行锁 version = version + 1 的方式来修改, 或者加锁, 防止数据重复更新
        int revision = model.getVersion() + 1;
        model.setVersion(revision);
        JSONObject metaInfo = JSON.parseObject(model.getMetaInfo());
        metaInfo.put(ModelDataJsonConstants.MODEL_NAME, dto.getName());
        metaInfo.put(ModelDataJsonConstants.MODEL_REVISION, revision);
        metaInfo.put(ModelDataJsonConstants.MODEL_DESCRIPTION, dto.getDescription());
        // json 格式存储流程定义信息
        model.setMetaInfo(JSON.toJSONString(metaInfo));
        // 修改模型到 act_re_model 表（repositoryService 中修改和保存的方法是同一个）
        repositoryService.saveModel(model);

        byte[] modelData = repositoryService.getModelEditorSource(dto.getId());
        // 如果设计类型是 activiti modeler,
        if (!Arrays.isNullOrEmpty(modelData)) {
            // 设计类型:1-activiti modeler;2-bpmn-js;
            if (dto.getDesignType().equals(1)) {
                // 更新 activiti-modeler 流程设计文件
                saveJsonXml(JSON.parseObject(new String(modelData, StandardCharsets.UTF_8)),
                        dto.getId(), dto.getName(), dto.getDescription(), dto.getAuthor(), revision);
            } else {
                // 更新 bpmn-js 流程设计文件
                saveBpmnJsXml(new String(modelData, StandardCharsets.UTF_8), dto.getId(), dto.getKey(), dto.getName(), dto.getDescription(), revision);
            }
        }
        return true;
    }

    @Override
    public void saveJsonXml(JSONObject bpmnXml, String id, String name, String description, String author, int revision) {
        // 修改流程文件中的版本号 ( 这里看需求, 是以模型的版本号还是取流程设计的版本号 )
        JSONObject properties = bpmnXml.getJSONObject(EditorJsonConstants.EDITOR_SHAPE_PROPERTIES);
        if (null == properties) {
            // 配置模版属性 ( stencil properties ) , 对应设计面版上的字段
            properties = new JSONObject();
        }
        // 名称
        properties.put(StencilConstants.PROPERTY_NAME, name);
        // 描述
        properties.put(StencilConstants.PROPERTY_DOCUMENTATION, description);
        if (StringUtils.isNotEmpty(author)) {
            // 新增和编辑模型页面修改作者
            properties.put(StencilConstants.PROPERTY_PROCESS_AUTHOR, author);
        }
        // 流程唯一标识, 必须是下划线或者字母开头, 否则报错: cvc-datatype-valid.1.2.1: '0ee903b8-9695-11ef-beca-d6edbbd75e0a' 不是 'NCName' 的有效值。
        properties.put(StencilConstants.PROPERTY_PROCESS_ID, "_" + id);
        // 我这里是把模型的版本号作为流程设计版本号, 所以修改流程设计中的流程版本会不生效
        properties.put(StencilConstants.PROPERTY_PROCESS_VERSION, String.valueOf(revision));
        bpmnXml.put(EditorJsonConstants.EDITOR_SHAPE_PROPERTIES, properties);
        // 保存模型文件到 act_ge_bytearray 表
        repositoryService.addModelEditorSource(id, bpmnXml.toJSONString().getBytes(StandardCharsets.UTF_8));
    }

    @Override
    public void saveBpmnJsXml(String xmlString, String id, String key, String name, String description, int revision) {
        if (StringUtils.isBlank(xmlString)) {
            // 为空则新增 bpmn-js 模型文件
            // 初始化一个开始节点的 bpmn-js 模型, 注意, 这里的 xml 我在设计界面中-> 常规-可执行文件勾选好了, 如果不勾选部署的时候会报错:
            // All process definition are set to be non-executable (property 'isExecutable' on process). This is not allowed. - [Extra info : ]
            String xml = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<bpmn:definitions xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:bpmn=\"http://www.omg.org/spec/BPMN/20100524/MODEL\" xmlns:bpmndi=\"http://www.omg.org/spec/BPMN/20100524/DI\" xmlns:dc=\"http://www.omg.org/spec/DD/20100524/DC\" xmlns:camunda=\"http://camunda.org/schema/1.0/bpmn\" targetNamespace=\"http://bpmn.io/schema/bpmn\"><bpmn:process id=\"${id}\" name=\"${name}\" isExecutable=\"true\" camunda:versionTag=\"${version}\"><bpmn:documentation>${description}</bpmn:documentation><bpmn:startEvent id=\"${startId}\" /></bpmn:process><bpmndi:BPMNDiagram id=\"BPMNDiagram_${key}\"><bpmndi:BPMNPlane id=\"BPMNPlane_${key}\" bpmnElement=\"${id}\"><bpmndi:BPMNShape id=\"_BPMNShape_${startId}\" bpmnElement=\"${startId}\"><dc:Bounds x=\"173\" y=\"102\" width=\"36\" height=\"36\" /></bpmndi:BPMNShape></bpmndi:BPMNPlane></bpmndi:BPMNDiagram></bpmn:definitions>";
            String svg = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<!-- created with bpmn-js / http://bpmn.io -->\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\" \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"46\" height=\"46\" viewBox=\"168 97 46 46\" version=\"1.1\"><g class=\"djs-group\"><g class=\"djs-element djs-shape\" data-element-id=\"${startId}\" style=\"display: block;\" transform=\"matrix(1 0 0 1 173 102)\"><g class=\"djs-visual\"><circle cx=\"18\" cy=\"18\" r=\"18\" style=\"stroke-linecap: round; stroke-linejoin: round; stroke: rgb(34, 36, 42); stroke-width: 2px; fill: white; fill-opacity: 0.95;\"/></g><rect class=\"djs-hit djs-hit-all\" x=\"0\" y=\"0\" width=\"36\" height=\"36\" style=\"fill: none; stroke-opacity: 0; stroke: white; stroke-width: 15px;\"/><circle cx=\"18\" cy=\"18\" r=\"23\" class=\"djs-outline\" style=\"fill: none;\"/></g></g></svg>";

            // 把 id, name, version 动态赋值 到 xml 中 ${name}
            Map<String, Object> variables = new HashMap<>();
            // 注意，id 流程唯一标识, 必须是下划线或者字母开头
            variables.put("id", "_" + id);
            variables.put("name", name);
            variables.put("description", description);
            variables.put("key", key);
            variables.put("version", revision);
            variables.put("startId", "sid-" + UUID.randomUUID());

            // 替换初始化模板里面相关属性值
            xml = XmlUtil.replaceXml(xml, variables);
            // 添加流程设计文件, 注意, activiti-modeler 保存的是 json, bpmn-js 保存的是 xml
            repositoryService.addModelEditorSource(id, xml.getBytes(StandardCharsets.UTF_8));

            // 添加流程图片信息
            saveSvg(id, XmlUtil.replaceXml(svg, variables));

        } else {
            // 修改模型文件里面的属性
            // name
            String elementName = "bpmn:process";
            String attributeName = "name";
            String newAttributeValue = name;
            xmlString = XmlUtil.setElementAttribute(xmlString, elementName, attributeName, newAttributeValue);

            // version
            attributeName = "camunda:versionTag";
            newAttributeValue = revision + "";
            xmlString = XmlUtil.setElementAttribute(xmlString, elementName, attributeName, newAttributeValue);

            // description
            elementName = "bpmn:documentation";
            xmlString = XmlUtil.setElementContent(xmlString, elementName, description);

            // 更新流程设计文件, 注意, activiti-modeler 保存的是 json, bpmn-js 保存的是 xml
            repositoryService.addModelEditorSource(id, xmlString.getBytes(StandardCharsets.UTF_8));
        }
    }
}
````

- 之后就是更新模型设计时，把版本号提取一下：

`io.github.cmmplb.activiti.service.impl.BpmnJsServiceImpl`

````java
    public boolean saveDesign(BpmnJsDTO dto) {
    Model model = repositoryService.getModel(dto.getId());
    if (null == model) {
        throw new BusinessException("模型信息不存在");
    }
    // 获取 xml 标签中的值
    String name = XmlUtil.getElementAttribute(dto.getXml(), "bpmn:process", "name");
    String description = XmlUtil.getElementContent(dto.getXml(), "bpmn:documentation");
    // 版本号, 这里直接在代码里加 1 了, 应该在数据库利用行锁 version = version + 1 的方式来修改, 或者加锁, 防止数据重复更新
    int revision = model.getVersion() + 1;
    JSONObject metaInfo = JSON.parseObject(model.getMetaInfo());
    // 设计界面也可以修改相关模型信息
    if (StringUtils.isNotEmpty(name)) {
        metaInfo.put(ModelDataJsonConstants.MODEL_NAME, name);
        model.setName(name);
    }
    if (StringUtils.isNotEmpty(description)) {
        metaInfo.put(ModelDataJsonConstants.MODEL_DESCRIPTION, description);
    }
    // 版本号从模型信息中获取, 因为设计页面上的版本号是字符串, 而模型信息的版本号是 int, 防止转换异常
    metaInfo.put(ModelDataJsonConstants.MODEL_REVISION, revision);
    model.setMetaInfo(metaInfo.toString());
    model.setVersion(revision);
    // 更新模型信息
    repositoryService.saveModel(model);

    // 更新模型设计文件中的版本号
    String xml = XmlUtil.setElementAttribute(dto.getXml(), "bpmn:process", "camunda:versionTag", revision + "");
    // 更新流程设计文件, 注意, activiti-modeler 保存的是 json, bpmn-js 保存的是 xml
    repositoryService.addModelEditorSource(dto.getId(), xml.getBytes(StandardCharsets.UTF_8));

    // 更新流程图片信息
    modelService.saveSvg(dto.getId(), dto.getSvg());
    return true;
}
````

重启，修改模型，并且打开 bpmn-js 设计页面，可以看到名称、元素文档、版本号已经更新了。

然后再在设计页面中修改名称，元素文档，回到模型页面也同步更新。

## 前端

这里添加一个代码高亮组件来显示流程定义文件，添加依赖（两种方式执行一种就行）

**npm 方式添加**

````shell
npm install highlight.js
````

**yarn 方式添加**

````shell
yarn add highlight.js
````

- 接口 api 和 ts 类型声明

`spring-boot-activiti/web/src/api/process/definition.ts`

````typescript
import request from '@/utils/http/axios';
import {PageResult, QueryPageBean, Result} from '@/utils/http/axios/axios';

enum Api {
  BASE = '/process/definition',
  PAGED = BASE + '/paged',
  REMOVE = BASE + '/',
  SHOW = BASE + '/show/',
  SHOW_CHART = BASE + '/show/chart/',
  SHOW_CHART_BPMN_JS = BASE + '/show/chart/bpmn-js/',
  EXCHANGE = BASE + '/exchange/',
  SUSPEND = BASE + '/suspend/',
  ACTIVATE = BASE + '/activate/',
}

/**
 * 分页条件查询列表
 */
export const getByPaged = (data: QueryPageBean) => {
  return request.post<Result<PageResult<ProcessDefinitionVO>>>({
    url: Api.PAGED,
    data
  });
};

/**
 * 查看流程文件
 */
export const show = (deploymentId: string, params: any) => {
  return request.get<Result<string>>({
    url: Api.SHOW + deploymentId,
    params
  });
};

/**
 * 查看流程图
 */
export const showChart = (id: string) => {
  return request.get<Blob>({
    url: Api.SHOW_CHART + id,
    // 重要! 设置响应类型为 blob 或 arraybuffer
    responseType: 'blob'
  });
};

/**
 * 查看流程图-bpmn-js
 */
export const showChartBpmnJs = (id: string) => {
  return request.get<Result<string>>({
    url: Api.SHOW_CHART_BPMN_JS + id
  });
};

/**
 * 将流程定义转为模型
 */
export const exchangeToModel = (id: string, designType: number) => {
  return request.post<Result<boolean>>({
    url: Api.EXCHANGE + id + '/' + designType
  });
};

/**
 * 挂起流程定义
 */
export const suspend = (id: string, data: SuspendDefinitionDTO) => {
  return request.post<Result<boolean>>({
    url: Api.SUSPEND + id,
    data
  });
};

/**
 * 激活流程定义
 */
export const activate = (id: string, data: SuspendDefinitionDTO) => {
  return request.post<Result<boolean>>({
    url: Api.ACTIVATE + id,
    data
  });
};
````

`spring-boot-activiti/web/src/api/process/types/definition.d.ts`

````typescript
// declare关键字用于告诉编译器某个标识符已经存在，但不需要进行类型检查
declare interface ProcessDefinitionVO {
  id: string;
  category: string;
  name: string;
  key: string;
  description: string;
  version: number;
  resourceName: string;
  deploymentId: string;
  diagramResourceName: string;
  suspended: boolean;
  appVersion: number;
}

declare interface SuspendDefinitionDTO {
  id: string;
  activateProcessInstances: boolean;
  activationDate: string;
}
````

- 添加 definition/index.vue 页面

`spring-boot-activiti/web/src/views/process/definition/index.vue`

````vue
<template>
  <div class='definition-container'>
    <!-- 通过shadow属性设置卡片阴影出现的时机：always、hover或never -->
    <el-card shadow="always" class="search-card">
      <!-- 搜索表单区域 -->
      <!-- inline 属性可以让表单域变为行内的表单域 -->
      <el-form inline :model="searchForm" class="search-form">
        <el-row>
          <el-col :span="4">
            <el-form-item label="关键词">
              <el-input class="search-type-options" v-model="searchForm.keywords" clearable
                        placeholder="关键词"></el-input>
            </el-form-item>
          </el-col>
          <el-col :span="3">
            <el-form-item>
              <el-button type="primary" icon="Search" @click="handlerSearch">查 询</el-button>
            </el-form-item>
          </el-col>
        </el-row>
      </el-form>
    </el-card>

    <el-card shadow="always" class="content-card">
      <!-- 表格区域 -->
      <Table
        :columns="columns"
        :data="data"
        showPagination
        @pagination="paginationChange"
        :paginationData="paginationData"
      >
        <template #buttons>
          <el-table-column fixed="right" align="center" label="操作" min-width="120" width="240">
            <template #default="scope">
              <el-button
                icon="Outline"
                @click="handlerShow(scope.row)"
                text
                style="color: #ff5f00"
              >查看流程文件
              </el-button
              >
              <el-button
                icon="View"
                @click="handlerShowChart(scope.row)"
                text
                style="color: rgba(6,190,213,0.98)"
              >查看流程图
              </el-button
              >
              <el-button
                icon="View"
                @click="handlerShowChartBpmnJs(scope.row)"
                text
                style="color: rgb(128,105,105)"
              >查看流程图(bpmn-js)
              </el-button
              >
              <el-button
                icon="Flag"
                @click="handlerExchangeModel(scope.row)"
                text
                style="color: #b700ff"
              >转为模型
              </el-button
              >
              <el-button
                :icon="scope.row.suspended ? 'Play' : 'Pause'"
                @click="handlerSuspended(scope.row)"
                text
                :style="'color: ' + (scope.row.suspended ? 'rgb(68,179,3)' : 'blue')"
              >{{ scope.row.suspended ? '激活' : '挂起' }}
              </el-button
              >
            </template>
          </el-table-column>
        </template>
      </Table>
    </el-card>

    <!-- 流程文件预览弹窗 -->
    <el-dialog title="流程文件预览" v-model="processDefineVisible" width="85%" top="3vh" style="padding: 10px"
               :before-close="handlerCloseProcessDefineVisible">
      <pre>
        <code class="hljs" v-html="highlightedCode()"></code>
      </pre>
      <template #footer>
        <div class="dialog-footer">
          <el-button type="primary" @click="handlerCloseProcessDefineVisible">关 闭</el-button>
        </div>
      </template>
    </el-dialog>

    <!-- 流程图预览 -->
    <el-dialog title="流程图预览" v-model="processChartVisible"
               :before-close="handlerCloseProcessChart">
      <template v-if="showBpmnProcess">
        <!-- 画布 -->
        <div id="canvas" ref="canvasRef"></div>
      </template>
      <template v-else>
        <img :src="img">
      </template>
      <template #footer>
        <div class="dialog-footer">
          <el-button type="primary" @click="handlerCloseProcessChart">关 闭</el-button>
        </div>
      </template>
    </el-dialog>

    <!-- 挂起/激活弹窗 -->
    <el-dialog :title="suspended ? '激活' : '挂起'" v-model="suspendedVisible" style="max-width: 500px;padding: 50px"
               :before-close="handlerCloseSuspended">
      <el-form
        label-width="auto"
        ref="dataFormRef"
        :model="form"
        :rules="rules"
      >
        <el-form-item :label="(suspended ? '激活' : '挂起') + '关联流程实例'" prop="activateProcessInstances">
          <el-switch v-model="form.activateProcessInstances"/>
        </el-form-item>
        <el-form-item :label="'定时' + (suspended ? '激活' : '挂起') + '时间'" prop="activationDate">
          <el-date-picker v-model="form.activationDate" type="datetime"
                          :placeholder="'请选择定时'+ (suspended ? '激活' : '挂起') + '时间'"
                          value-format="yyyy-MM-DD HH:mm:ss"/>
        </el-form-item>
      </el-form>
      <template #footer>
        <div class="dialog-footer">
          <el-button @click="handlerCloseSuspended">取 消</el-button>
          <el-button type="primary" @click="handlerConfirmSuspended(dataFormRef)">确 定</el-button>
        </div>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">

import Table from '@/components/table/index.vue';
import {markRaw, onMounted, reactive, ref} from 'vue';
import {QueryPageBean} from '@/utils/http/axios/axios';
import {
  activate,
  exchangeToModel,
  getByPaged,
  show,
  showChart,
  showChartBpmnJs,
  suspend
} from '@/api/process/definition.ts';
// 设计器, bpmn-js有两种模式: Modeler 模式和 Viewer 模式, 在 Modeler 模式下可以对流程图进行编辑, 而 Viewer 模式则不能, 仅作为展示用
import ViewerModeler from 'bpmn-js/lib/Viewer';

import {ElMessage, ElMessageBox, FormInstance, FormRules} from 'element-plus';
import hljs from 'highlight.js';
// 加载默认主题
// import 'highlight.js/styles/default.css';
// dark
// import 'highlight.js/styles/github-dark.css';
// 高亮主题, 还有一些其他主题都在 highlight.js/styles 目录下, 可以自己切换
import 'highlight.js/styles/intellij-light.css';

// reactive 一般定义响应式数据, 例如数组、对象等, ref 一般定义基础类型数据, 例如字符串、数字等

// 表格列配置
const columns = reactive<Column[]>([
  {
    prop: 'name',
    label: '部署名称',
    width: 140
  },
  {
    prop: 'key',
    label: '关键字'
  },
  {
    prop: 'category',
    label: '类型'
  },
  {
    prop: 'version',
    label: '版本',
    width: 100
  },
  {
    prop: 'resourceName',
    label: '资源路径'
  },
  {
    prop: 'diagramResourceName',
    label: '图片资源文件名称',
    width: 180
  },
  {
    prop: 'suspended',
    label: '状态',
    width: 180,
    option: [
      {
        value: false,
        label: '激活',
        tagType: 'success'
      },
      {
        value: true,
        label: '挂起',
        tagType: 'warning'
      }
    ]
  },
  {
    prop: 'appVersion',
    label: '自定义应用版本号',
    width: 120
  }
]);
// Vue 3 写法, 获取 ref 定义的组件实例
const dataFormRef = ref<FormInstance>();
// 表单参数
const form = reactive<SuspendDefinitionDTO>({
  id: '',
  activateProcessInstances: true,
  activationDate: ''
});
// 表单校验规则
const rules = reactive<FormRules<SuspendDefinitionDTO>>({
  activateProcessInstances: [
    {required: true, message: '请选择挂起关联流程实例', trigger: 'blur'}
  ]
});
// 表格数据集
const data = ref([]);
// 搜索表单
const searchForm = reactive<QueryPageBean>({
  keywords: ''
});
// 分页参数
const paginationData = reactive<Pagination>({
  size: 10,
  current: 1,
  total: 0
});
// 流程文件预览弹窗是否显示
const processDefineVisible = ref(false);
// 流程图预览弹窗是否显示
const processChartVisible = ref(false);
// 挂起/激活弹窗是否显示
const suspendedVisible = ref(false);
// 是否显示 bpmn-js 流程图
const showBpmnProcess = ref(false);
// activiti-modeler 流程图片
const img = ref();
// 流程文件内容
const text = ref('');
// 挂起/激活状态
const suspended = ref(false);
// bpmn-js 流程图实例
const bpmnModeler = ref();

// 挂载完毕后执行的回调函数
onMounted(() => {
  getData();
});

// 点击搜索按钮
const handlerSearch = () => {
  getData();
};

// 获取表格数据
const getData = async () => {
  const res = await getByPaged({...searchForm, ...paginationData});
  if (res.code === 200 && res.data) {
    data.value = res.data.rows;
    paginationData.total = res.data.total;
  } else {
    ElMessage({message: res.msg, type: 'error'});
  }
};

// 分页改变调用的事件
const paginationChange = (data: ProcessDefinitionVO) => {
  // 把原来的值覆盖
  Object.assign(paginationData, {...paginationData, ...data});
  getData();
};

// 点击查看流程文件按钮
const handlerShow = async (row: ProcessDefinitionVO) => {
  processDefineVisible.value = true;
  const res = await show(row.deploymentId, {resourceName: row.resourceName});
  if (res.code === 200 && res.data) {
    text.value = res.data;
  } else {
    ElMessage({message: res.msg, type: 'error'});
  }
};

/** 高亮显示 */
const highlightedCode = () => {
  const result = hljs.highlight(text.value, {language: 'xml', ignoreIllegals: true});
  return result.value || '&nbsp;';
};

// 点击查看流程图
const handlerShowChart = async (row: ProcessDefinitionVO) => {
  // 设置是否显示 bpmn-js 流程图为 false
  showBpmnProcess.value = false;
  // 显示流程图弹窗
  processChartVisible.value = true;
  // 转换流响应到弹窗
  const res = await showChart(row.id);
  if (typeof window !== 'undefined' && window.URL) {
    // 将 blob 对象 生成 BlobURL
    img.value = window.URL.createObjectURL(res);
  }
};

// Vue 3 写法, 获取 ref 定义的组件实例
const canvasRef = ref();

// 点击查看流程图(bpmn-js)
const handlerShowChartBpmnJs = async (row: ProcessDefinitionVO) => {
  // 设置是否显示 bpmn-js 流程图为 true
  showBpmnProcess.value = true;
  // 显示流程图弹窗
  processChartVisible.value = true;
  if (bpmnModeler.value) {
    // 如果存在就销毁重新创建，否则会不停添加流程
    bpmnModeler.value.destroy();
  }

  const res = await showChartBpmnJs(row.id);
  if (res.code === 200 && res.data) {
    // toRaw 方法可以将一个被 reactive 包裹的对象还原为其中的原始对象，从而使其不再具有任何响应式能力。
    // markRaw 方法可以将一个对象标记为非响应式，从而使其不会被 reactive 包裹，也就不会成为 Vue3 中的响应式对象。
    // BpmnViewer 预览、BpmnModeler 操作
    bpmnModeler.value = markRaw(new ViewerModeler({
      container: canvasRef.value
    }));
    await bpmnModeler.value.importXML(res.data);

    const canvas = bpmnModeler.value.get('canvas');
    // 使流程图自适应屏幕
    canvas.zoom('fit-viewport', 'auto');
    canvas.zoom(0.8); //缩写至0.8倍
  }
};

// 点击转为模型按钮
const handlerExchangeModel = async (row: ProcessDefinitionVO) => {
  // 给个默认值 1
  let designType: number = 1;
  await ElMessageBox.confirm('是否确认转换名称为"' + row.name + '"的流程定义为模型？', '转换模型', {
      confirmButtonText: '转换为 bpmn-js',
      cancelButtonText: '转换为 activiti-modeler',
      type: 'success'
    }
  ).then(async () => {
    // 转换为 bpmn-js
    designType = 2;
  }).catch(() => {
    // 转换为 activiti-modeler
    designType = 1;
  });
  console.log('designType:', designType);
  const res = await exchangeToModel(row.id, designType);
  if (res.code === 200 && res.data) {
    await getData();
    ElMessage({type: 'success', message: '转换成功'});
  } else {
    ElMessage({type: 'error', message: res.msg});
  }
};

// 点击激活/挂起按钮
const handlerSuspended = async (row: ProcessDefinitionVO) => {
  form.id = row.id;
  suspended.value = row.suspended;
  suspendedVisible.value = true;
};

// 关闭流程文件预览弹窗
const handlerCloseProcessDefineVisible = () => {
  processDefineVisible.value = false;
};

// 关闭流程图预览弹窗
const handlerCloseProcessChart = () => {
  processChartVisible.value = false;
};

// 关闭挂起/激活弹窗
const handlerCloseSuspended = () => {
  suspendedVisible.value = false;
};

// 确定挂起/激活
const handlerConfirmSuspended = async (formEl: FormInstance | undefined) => {
  if (!formEl) return;
  await formEl.validate(async (valid, fields) => {
      if (valid) {
        let res;
        console.log('suspended:', suspended.value);
        if (suspended.value) {
          // 设置是否挂起为 false
          suspended.value = false;
          res = await activate(form.id, form);
        } else {
          // 设置是否挂起为 false
          suspended.value = true;
          res = await suspend(form.id, form);
        }
        if (res.code === 200 && res.data) {
          ElMessage({message: suspended.value ? '挂起成功' : '激活成功', type: 'success'});
          // 搜索刷新列表
          await getData();
          // 关闭弹窗
          handlerCloseSuspended();
        } else {
          ElMessage({message: res.msg, type: 'error'});
        }
      } else {
        console.log('未通过字段校验:', fields);
      }
    }
  );
};
</script>

<style scoped lang='scss'>

</style>
````

- 路由和菜单

`spring-boot-activiti/web/src/router/index.ts`

````typescript
// 公共静态路由
const constantRoutes = [
  // ...
  {
    path: '/process',
    component: Layout,
    // 重定向到 /process, 效果是访问 /process 重定向到 /process/model
    redirect: '/process/model',
    children: [
      // ...
      {
        path: '/process/definition',
        component: () => import ('@/views/process/definition/index.vue'),
        name: '定义管理'
      }
    ]
  }
];
````

`spring-boot-activiti/web/src/const/constant.ts`

````typescript
import {reactive} from 'vue';

/**
 * 菜单列表, 后续可以从后台获取
 */
export const menuList = reactive<Array<Menu>>([
  // ...
  {
    'id': 2,
    'name': '流程管理',
    'icon': 'Platform',
    'path': '/process',
    'parentId': 0,
    'children': [
      // ...
      {
        'id': 5,
        'name': '定义管理',
        'icon': 'Tickets',
        'path': '/process/definition',
        'parentId': 2
      }
    ]
  }
]);
````

由于这里的激活和挂起是 boolean 类型，在 table.d.ts 的 Option value 属性添加一个 boolean

`spring-boot-activiti/web/src/components/table/table.d.ts`

````typescript
// 添加一个 boolean 类型
declare interface Option {
// 选项值
  value: string | number | boolean,
}
````

## bug 和其他事项

1. bpmn-js.vue 保存的时候，刷新一下预览，更新版本

````typescript
// 保存按钮事件
const handlerSave = async (close?: boolean) => {
  // ...
  const res = await save(String(modelId), {xml, svg});
  if (res.code === 200 && res.data) {
    ElMessage({message: res.msg, type: 'success'});
    // 获取模型信息, 刷新预览
    await preview();
    // ...
  }
}
````